import{EntityDamageCause}from"@minecraft/server";import{secondsToTicks,randInt}from"./libs/utils";import{bVector2,bVector3}from"./libs/better_vectors";const BLOCK_TRANSFORMATIONS={grass_block:["minecraft:podzol","minecraft:dirt","minecraft:dirt_with_roots","minecraft:coarse_dirt"],short_grass:["minecraft:short_dry_grass"],fern:["minecraft:short_dry_grass"],bush:["minecraft:deadbush"],firefly_bush:["minecraft:deadbush"],sweet_berry_bush:["minecraft:deadbush"],oak_sapling:["minecraft:deadbush"],spruce_sapling:["minecraft:deadbush"],birch_sapling:["minecraft:deadbush"],jungle_sapling:["minecraft:deadbush"],acacia_sapling:["minecraft:deadbush"],dark_oak_sapling:["minecraft:deadbush"],cherry_sapling:["minecraft:deadbush"],pale_oak_sapling:["minecraft:deadbush"],mangrove_propagule:["minecraft:deadbush"],tall_grass:["minecraft:air"],large_fern:["minecraft:air"],dandelion:["minecraft:air"],poppy:["minecraft:air"],blue_orchid:["minecraft:air"],allium:["minecraft:air"],azure_bluet:["minecraft:air"],red_tulip:["minecraft:air"],orange_tulip:["minecraft:air"],white_tulip:["minecraft:air"],pink_tulip:["minecraft:air"],oxeye_daisy:["minecraft:air"],cornflower:["minecraft:air"],lily_of_the_valley:["minecraft:air"],sunflower:["minecraft:air"],lilac:["minecraft:air"],rose_bush:["minecraft:air"],peony:["minecraft:air"],pitcher_plant:["minecraft:air"],pink_petals:["minecraft:air"],wildflowers:["minecraft:air"],torchflower:["minecraft:air"],closed_eyeblossom:["minecraft:air"],open_eyeblossom:["minecraft:air"],cactus_flower:["minecraft:air"]};export const DATA={id:"hfrlc:tree_spirit",states:{none:"none",preparing_attack:"preparing_attack",attacking:"attacking",healing:"healing"},attack_types:{none:"none",quick_attack:"quick_attack",heavy_attack:"heavy_attack"},attack_damage:{quick_attack:12,heavy_attack:16},attack_delay:{quick_attack:secondsToTicks(.4),heavy_attack:secondsToTicks(.6)},attack_effect_radius:{quick_attack:5,heavy_attack:5},attack_knockback:{quick_attack:-2.5,heavy_attack:3},healing:{start_time:secondsToTicks(.75),end_time:secondsToTicks(2.5),anim_end_time:secondsToTicks(3.05),cooldown:secondsToTicks(10),amount:1,threshold:.25,drain_radius:7,damage:.1},heavy_attack:{stuck_duration:secondsToTicks(1.04),time_min:2,time_max:4}};export function tick(t){if(!t.getProperty("hfrlc:dead")){let a=t.getComponent("minecraft:health");void 0===t.getDynamicProperty("hfrlc:healing_cooldown")?t.setDynamicProperty("hfrlc:healing_cooldown",0):t.getDynamicProperty("hfrlc:healing_cooldown")>0&&t.setDynamicProperty("hfrlc:healing_cooldown",t.getDynamicProperty("hfrlc:healing_cooldown")-1),void 0===t.getDynamicProperty("hfrlc:attack_time")&&t.setDynamicProperty("hfrlc:attack_time",0),void 0===t.getDynamicProperty("hfrlc:healing_time")&&t.setDynamicProperty("hfrlc:healing_time",0),void 0===t.getDynamicProperty("hfrlc:heavy_attack_delay")&&t.setDynamicProperty("hfrlc:heavy_attack_delay",0);let e=0,r=0;if(t.getProperty("hfrlc:state")===DATA.states.attacking){let a=t.getProperty("hfrlc:attack_type");e=t.getDynamicProperty("hfrlc:attack_time")+1,t.setDynamicProperty("hfrlc:attack_time",e),e===DATA.attack_delay[a]&&t.setDynamicProperty("hfrlc:heavy_attack_delay",attackEffect(t,a)),a===DATA.attack_types.heavy_attack&&e>=DATA.attack_delay[a]+t.getDynamicProperty("hfrlc:heavy_attack_delay")&&t.setProperty("hfrlc:stuck",!1)}else if(t.setDynamicProperty("hfrlc:attack_time",0),t.setDynamicProperty("hfrlc:heavy_attack_delay",0),t.getProperty("hfrlc:state")===DATA.states.healing){if(r=t.getDynamicProperty("hfrlc:healing_time")+1,t.setDynamicProperty("hfrlc:healing_time",r),r>=DATA.healing.start_time&&r<=DATA.healing.end_time){let e=(r-DATA.healing.start_time)/(DATA.healing.end_time-DATA.healing.start_time),i=Math.round(DATA.healing.drain_radius*e),c=1-e;for(let a=-i;a<=i;a++)if(!(Math.abs(a)>1&&Math.abs(a)<Math.abs(a)-1))for(let e=-i;e<=i;e++)if(!(Math.abs(e)>1&&Math.abs(e)<Math.abs(e)-1))for(let r=1;r>=-3;r--){let n=t.dimension.getBlock(t.location).center(),o=t.dimension.getBlock({x:n.x+a,y:n.y+r,z:n.z+e});if(o&&bVector3.distance(n,o)<=i){let t=o?.typeId?.split(":")[1],a=BLOCK_TRANSFORMATIONS[t];if(a&&Math.random()<=c){let t=a[Math.floor(Math.random()*a.length)];o?.setType(t)}}}a.currentValue<a.effectiveMax&&a.setCurrentValue(a.currentValue+DATA.healing.amount);const n=t.dimension.getEntities({location:t.location,maxDistance:i,excludeFamilies:["inanimate"],excludeTypes:[DATA.id,...KNOCKBACK_EXCLUDED_ENTITIES]});for(const a of n)a?.isOnGround&&a?.applyDamage(DATA.healing.damage,{cause:EntityDamageCause.entityAttack,damagingEntity:t})}r>=DATA.healing.anim_end_time&&(t.triggerEvent("hfrlc:end_healing"),t.setDynamicProperty("hfrlc:healing_cooldown",DATA.healing.cooldown))}else t.setDynamicProperty("hfrlc:healing_time",0),t.getProperty("hfrlc:state")===DATA.states.none&&0===t.getDynamicProperty("hfrlc:healing_cooldown")&&a.currentValue<=a.effectiveMax*DATA.healing.threshold&&t.triggerEvent("hfrlc:start_healing")}}function attackEffect(t,a){if("attacking"!==t.getProperty("hfrlc:state"))return;const e=t.dimension.getEntities({location:t.location,maxDistance:DATA.attack_effect_radius[a],excludeFamilies:["inanimate"],excludeTypes:[DATA.id,...KNOCKBACK_EXCLUDED_ENTITIES]});for(const r of e){let e=bVector3.fromVector3(t.location),i=bVector3.fromVector3(r.location),c=bVector3.subtract(i,e),n=a===DATA.attack_types.quick_attack?2-c.magnitude()/DATA.attack_effect_radius[a]:0;if(r.applyKnockback(c.x,c.z,DATA.attack_knockback[a]*n,.25),a===DATA.attack_types.quick_attack)return r.applyDamage(DATA.attack_damage[a],{cause:EntityDamageCause.entityAttack,damagingEntity:t}),0;if(a===DATA.attack_types.heavy_attack)return r.applyDamage(DATA.attack_damage[a],{cause:EntityDamageCause.entityAttack,damagingEntity:t}),t.setProperty("hfrlc:stuck",!0),randInt(DATA.heavy_attack.time_min,DATA.heavy_attack.time_max)*DATA.heavy_attack.stuck_duration??DATA.heavy_attack.stuck_duration}}export function onEvent(t){t.entity.typeId===DATA.id&&("hfrlc:attack_start"!==t.eventId&&"hfrlc:start_healing"!==t.eventId&&"hfrlc:death"!==t.eventId||t.entity.getProperty("hfrlc:rotation_locked")?"hfrlc:attack_end"!==t.eventId&&"hfrlc:end_healing"!==t.eventId||t.entity.setProperty("hfrlc:rotation_locked",!1):(t.entity.setProperty("hfrlc:rotation",t.entity.getRotation().y),t.entity.setProperty("hfrlc:rotation_locked",!0)))}export const KNOCKBACK_EXCLUDED_ENTITIES=["minecraft:item","minecraft:arrow","minecraft:thrown_trident","minecraft:xp_bottle","minecraft:snowball","minecraft:ender_pearl","minecraft:eye_of_ender_signal","minecraft:egg","minecraft:fishing_hook"];