import{EntityDamageCause,system,world,GameMode}from"@minecraft/server";import{secondsToTicks,randInt}from"./libs/utils";import{bVector3}from"./libs/better_vectors";import{KNOCKBACK_EXCLUDED_ENTITIES}from"./tree_spirit";class DirectionOffset{constructor(t,e,a){this.ground=t,this.side=e,this.front=a}}export const DATA={id:"hfrlc:golem",states:{none:"none",emerging:"emerging",preparing_attack:"preparing_attack",attacking:"attacking",rolling:"rolling"},attack_types:{none:"none",right_attack:"right_attack",left_attack:"left_attack",roll:"roll",throw_tree:"throw_tree"},attack_data:{right_attack:{radius:5,knockback:1.5,knockback_up:.25,damage:12,delay:secondsToTicks(1.5),offset:new DirectionOffset(0,.5,2)},left_attack:{radius:5,knockback:1.5,knockback_up:.25,damage:12,delay:secondsToTicks(1.5),offset:new DirectionOffset(0,-.5,2)},roll:{radius:3,knockback:1.5,knockback_up:.25,damage:5,delay:secondsToTicks(.95),duration_min:secondsToTicks(4),duration_max:secondsToTicks(8),roll_speed:.2,roll_interval:1,jump_up_strength:.6,gravity:-.5,loop_duration:secondsToTicks(1.75),times_min:2,times_max:3,get_up_duration:secondsToTicks(1.75),stuck_failsafe_time:secondsToTicks(1)},throw_tree:{radius:16,knockback:1.5,knockback_up:.15,damage:0,projectile_speed:2.5,delay:secondsToTicks(2.8),extra_kill_check_delay:secondsToTicks(1),offset:new DirectionOffset(1.75,-1.5,3)}},killed_check_delay:secondsToTicks(2),dancing:{anim_time:secondsToTicks(1.17),min_time:3,max_time:5}};export async function tick(t){if(!t.getProperty("hfrlc:dead")&&t.getProperty("hfrlc:has_target")){let e=t.getDynamicProperty("hfrlc:target");if(e)e=world.getEntity(t.getDynamicProperty("hfrlc:target"));else{const a=await getTarget(t);a&&(e=a,t.setDynamicProperty("hfrlc:target",a.id))}if(t.getProperty("hfrlc:state")===DATA.states.preparing_attack){let a=t.getProperty("hfrlc:attack_type");a!==DATA.attack_types.roll&&system.runTimeout(()=>{attackEffect(t,a,e)},DATA.attack_data[a].delay),a===DATA.attack_types.roll&&system.runTimeout(()=>{t.triggerEvent("hfrlc:invulnerable");let r=system.runInterval(()=>{if(!t||!t?.isValid())return void system.clearRun(r);t.getProperty("hfrlc:has_target")&&void 0!==e&&e?.isValid()||endRoll(t,r,e),bVector3.fromVector3(t.getVelocity()).magnitude()<=.1?t.setProperty("hfrlc:roll_failsafe",t.getProperty("hfrlc:roll_failsafe")+1):t.setProperty("hfrlc:roll_failsafe",0),t.getProperty("hfrlc:roll_failsafe")>=DATA.attack_data.roll.stuck_failsafe_time&&endRoll(t,r,e);let o=getDirection(e,t);o.setMagnitude(DATA.attack_data.roll.roll_speed),t.setProperty("hfrlc:rotation",o.angles().theta),t.clearVelocity();let c=t.dimension.getBlockFromRay(t.location,o,{includeLiquidBlocks:!1,includePassableBlocks:!1,maxDistance:4});if(c&&c.block&&c.block.isValid()){let t=c.block.above();t&&t.isValid()&&(t.isAir||t.isLiquid||(o.y=DATA.attack_data.roll.jump_up_strength))}let i=t.dimension.getBlockFromRay(t.location,{x:0,y:-1,z:0},{includeLiquidBlocks:!1,includePassableBlocks:!1,maxDistance:5});if(i&&i.block&&i.block.isValid()){let e=bVector3.fromVector3(i.block.location);e.y=Math.floor(e.y)+1;let a=bVector3.fromVector3(t.location);bVector3.distance(a,e)>=1&&(o.y=DATA.attack_data.roll.gravity)}t.applyImpulse(o),attackEffect(t,a,e)},DATA.attack_data.roll.roll_interval),o=randInt(DATA.attack_data.roll.duration_min,DATA.attack_data.roll.duration_max);system.runTimeout(()=>{endRoll(t,r,e)},o)},DATA.attack_data.roll.delay)}else if(t.getProperty("hfrlc:state")===DATA.states.attacking){if(t.getProperty("hfrlc:attack_type")===DATA.attack_types.throw_tree&&!t.getDynamicProperty("hfrlc:threw_tree")){let a=getDirection(e,t);t.setProperty("hfrlc:rotation",a.angles().theta)}}}}async function attackEffect(t,e,a){if("attacking"===t.getProperty("hfrlc:state"))if(e===DATA.attack_types.right_attack||e===DATA.attack_types.left_attack){let a=rotationRelativeOffset(t,DATA.attack_data[e].offset);const r=t.dimension.getEntities({location:a,excludeGameModes:[GameMode.creative,GameMode.spectator],maxDistance:DATA.attack_data[e].radius,excludeFamilies:["inanimate"],excludeTypes:[DATA.id,...KNOCKBACK_EXCLUDED_ENTITIES]});for(const o of r){let r=bVector3.fromVector3(o.location),c=bVector3.subtract(r,a);o.applyKnockback(c.x,c.z,DATA.attack_data[e].knockback,DATA.attack_data[e].knockback_up),o.applyDamage(DATA.attack_data[e].damage,{cause:EntityDamageCause.entityAttack,damagingEntity:t}),t.runCommand("/camerashake add @a[r=16] 1.0 0.5 positional"),queueDance(t,o,DATA.killed_check_delay)}}else if(e===DATA.attack_types.throw_tree){t.setProperty("hfrlc:tree_thrown",!0),t.setDynamicProperty("hfrlc:threw_tree",!0);let r=rotationRelativeOffset(t,DATA.attack_data[e].offset),o=bVector3.fromVector3(a.getHeadLocation()),c=bVector3.subtract(o,r);c.setMagnitude(DATA.attack_data[e].projectile_speed);let i=t.dimension.spawnEntity("hfrlc:golem_tree",r.toVector3());i.setProperty("hfrlc:rotation_y",c.angles().phi),i.setProperty("hfrlc:rotation_x",c.angles().theta),i.setDynamicProperty("hfrlc:owner",t.id),i.applyImpulse(c),queueDance(t,a,DATA.killed_check_delay)}else if(e===DATA.attack_types.roll){const a=t.dimension.getEntities({location:t.location,excludeGameModes:[GameMode.creative,GameMode.spectator],maxDistance:DATA.attack_data[e].radius,excludeFamilies:["inanimate"],excludeTypes:[DATA.id,...KNOCKBACK_EXCLUDED_ENTITIES]});for(const r of a){let a=bVector3.fromVector3(r.location),o=bVector3.subtract(a,t.location);r.applyKnockback(o.x,o.z,DATA.attack_data[e].knockback,.25),r.applyDamage(DATA.attack_data[e].damage,{cause:EntityDamageCause.entityAttack,damagingEntity:t})}}}export function onEvent(t){t.entity.typeId===DATA.id&&("hfrlc:no_target"===t.eventId&&t.entity&&t.entity?.isValid()&&t.entity?.setDynamicProperty("hfrlc:target",void 0),"hfrlc:attack_start"!==t.eventId&&"hfrlc:death"!==t.eventId||t.entity.getProperty("hfrlc:rotation_locked")||(t.entity.setProperty("hfrlc:rotation",t.entity.getRotation().y),t.entity.setProperty("hfrlc:rotation_locked",!0)))}function endRoll(t,e,a){t?.setProperty("hfrlc:stuck",!0),t.triggerEvent("hfrlc:vulnerable"),t?.clearVelocity(),system.clearRun(e);let r=randInt(DATA.attack_data.roll.times_min,DATA.attack_data.roll.times_max);system.runTimeout(()=>{t&&t?.isValid()&&t?.setProperty("hfrlc:stuck",!1)},DATA.attack_data.roll.loop_duration*r),queueDance(t,a,DATA.killed_check_delay+DATA.attack_data.roll.loop_duration*r,!0,DATA.attack_data.roll.get_up_duration)}export function queueDance(t,e,a,r,o){system.runTimeout(()=>{const o=e?.getComponent("minecraft:health"),c=t?.getRotation().y;if(o?.currentValue<=0){if(t?.setProperty("hfrlc:rotation_locked",!0),t?.getDynamicProperty("hfrlc:dance_queued"))return;t?.setDynamicProperty("hfrlc:dance_queued",!0),system.runTimeout(()=>{if(!t.getProperty("hfrlc:has_target")){const e=randInt(DATA.dancing.min_time,DATA.dancing.max_time)*DATA.dancing.anim_time;t?.triggerEvent("hfrlc:start_dancing"),system.runTimeout(()=>{t?.setRotation({x:0,y:c}),t?.triggerEvent("hfrlc:stop_dancing"),t?.setProperty("hfrlc:rotation_locked",!1)},e)}},a)}r&&(!e||o?.currentValue>0)&&system.runTimeout(()=>{t?.setProperty("hfrlc:rotation_locked",!1)},DATA.attack_data.roll.get_up_duration)},o??0)}function rotationRelativeOffset(t,e){let a=bVector3.fromVector3(t.location);a.y+=e.ground;let r=bVector3.fromVector3(t.getViewDirection());r.setMagnitude(e.front);const o=bVector3.add(new bVector3(0,1,0),r);let c=bVector3.crossProduct(r,o);return c.setMagnitude(e.side),a.add(r),a.add(c),a}function getTarget(t){let e=!1;if(void 0!==t&&t?.isValid())return new Promise(a=>{t.triggerEvent("hfrlc:get_target");const r=system.afterEvents.scriptEventReceive.subscribe(t=>{if("hfrlc:get_target"===t.id)return e=!0,system.afterEvents.scriptEventReceive.unsubscribe(r),void a(t.sourceEntity)});system.runTimeout(()=>{system.afterEvents.scriptEventReceive.unsubscribe(r),e||a(null)},20)})}function getDirection(t,e){let a=bVector3.fromVector3(t.location),r=bVector3.fromVector3(e.location);return bVector3.subtract(a,r)}