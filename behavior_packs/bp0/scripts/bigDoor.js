import{world,system,BlockPermutation,BlockComponentPlayerInteractEvent}from"@minecraft/server";import{Vector}from"./vector.js";import{directionToInt,getVolumeFromLocalCoords}from"./functions.js";export function onInteract(t){const e=t.block,o=e.permutation.getTags(),n=t.player;if(o.includes("hfrlc:locked")){const t=n.getComponent("equippable").getEquipmentSlot("Mainhand"),e=t.getItem();if(!e||"hfrlc:key"!==e.typeId)return n.onScreenDisplay.setActionBar([{translate:"translate.hfrlc.need_key"}]),void n.dimension.playSound("note.banjo",n.location,{pitch:.5});r(),e.amount>1?(e.amount--,t.setItem(e)):t.setItem(void 0)}else r();function r(){const o=getSizeMultiblock(e),n=getBlocksAroundSize(e,o.height,o.width),r=e.permutation.getState("hfrlc:open");let i;i=!r,e.setPermutation(e.permutation.withState("hfrlc:open",i)),n.length>0&&n.forEach(o=>{if(o?.typeId===e.typeId){const n=o.permutation.getState("hfrlc:bottom"),r=o.permutation.getState("hfrlc:type"),c=o.permutation.getState("minecraft:cardinal_direction");o.setPermutation(o.permutation.withState("hfrlc:open",i)),system.run(()=>{if("bottom"===n&&"middle0"===r){if(!o.dimension.getEntities({location:Vector.add(o.center(),{x:0,y:-.5,z:0}),maxDistance:1,type:"hfrlc:dungeon_door_entity"})[0]){const n=o.dimension.spawnEntity("hfrlc:dungeon_door_entity",Vector.add(o.center(),{x:0,y:-.5,z:0})),r=directionToInt(c),i=doorTypeToInt(o.typeId.split("hfrlc:dungeon_door_")[1]);if(n.setRotation({x:0,y:r}),n.setProperty("hfrlc:type",i),4===i){n.setProperty("hfrlc:has_key",!0);t.face;const o=e.permutation.getState("minecraft:cardinal_direction");t.face.toLowerCase()===o?n.setProperty("hfrlc:key_orientation","back"):n.setProperty("hfrlc:key_orientation","front")}}}})}})}}export function onPlace(t){const e=t.block,o=t.permutationToPlace,n=o.getState("minecraft:cardinal_direction"),r=getSizeMultiblock(e,o);let i=!0;const c=[],l=Math.floor(r.width/2);for(let t=0;t<r.height;t++)for(let n=-l;n<=l;n++){const r=Vector.getBlockLocalCoord(e,{x:-n,y:t,z:0},o),l=e.dimension.getBlock(r);l&&"minecraft:air"!==l.typeId?i=!1:c.push(l.location)}i?c.forEach(t=>{const r=e.dimension.getBlock(t),i=Vector.subtract(t,e.location),c={"minecraft:cardinal_direction":n};i.y>0&&(c["hfrlc:bottom"]="top"+(i.y-1));let a="north"===n||"south"===n?i.x:i.z;"south"!==n&&"west"!==n||(a=-a),0===a?c["hfrlc:type"]="middle0":a===-l?c["hfrlc:type"]="left":a===l?c["hfrlc:type"]="right":a<0?c["hfrlc:type"]=`middle${Math.abs(a)}`:a>0&&(c["hfrlc:type"]=`middle${a}`),system.run(()=>{r.setPermutation(BlockPermutation.resolve(o.type.id,c))})}):t.cancel=!0}export function onDestroy(t){const e=t.block,o=t.destroyedBlockPermutation,n=getSizeMultiblock(e,o),r=getBlocksAroundSize(e,n.height,n.width,o);r.length>0&&r.forEach(t=>{t&&t.typeId===o.type.id&&t.dimension.setBlockType(t.location,"minecraft:air")})}export function onClose(t,e){if("hfrlc:dungeon_door_entity"!==t.typeId)return;const{dimension:o,location:n}=t;if("hfrlc:closed"===e){const t=o.getBlock(n),e=getSizeMultiblock(t);for(let n=0;n<e.height;n++)for(let r=Math.ceil(-e.width/2);r<Math.ceil(e.width/2);r++){const e=Vector.getBlockLocalCoord(t,{x:-r,y:n,z:0}),i=o.getBlock(e);i&&i.typeId===t.typeId&&i.setPermutation(i.permutation.withState("hfrlc:open",!1))}}}function getSizeMultiblock(t,e){let o;o=e||t.permutation;const n=o.getTags().map(t=>t.match(/(\d+)x(\d+)/)).filter(t=>t).map(([t,e,o])=>({height:parseInt(e),width:parseInt(o)}));return n.length>0?n[0]:{height:1,width:1}}function getBlocksAroundSize(t,e,o,n){const r=[];let i;i=n||t.permutation;const c=getVolumeFromLocalCoords(t,{x:0,y:-e,z:-o},{x:0,y:e,z:o},i),l=t.dimension.getBlocks(c,{includeTypes:[i.type.id]});for(const e of l.getBlockLocationIterator()){const o=t.dimension.getBlock(e);r.push(o)}return r}function doorTypeToInt(t){if(!t)return 0;return{desert:1,snow:2,red_desert:3,key:4}[t]??null}function getDirectionVector(t){switch(t){case"north":return{x:0,z:-1};case"south":return{x:0,z:1};case"west":return{x:-1,z:0};case"east":return{x:1,z:0};default:return{x:0,z:0}}}function isPlayerInFront(t,e,o){const n=getDirectionVector(o),r=t.x-(e.x+.5),i=t.z-(e.z+.5);return r*n.x+i*n.z>0}