import{system}from"@minecraft/server";import{Vector}from"./vector";const MELEE_DAMAGE=8,SPIN_ATTACK_DAMAGE=6,SPIN_ATTACK_COOLDOWN=500,anyType=["minecraft:player","minecraft:iron_golem","minecraft:snow_golem"],bannedBlocks=["minecraft:bedrock","minecraft:command_block","minecraft:obsidian","minecraft:repeating_command_block","minecraft:chain_command_block","minecraft:barrier","minecraft:jigsaw_block","minecraft:structure_block","minecraft:structure_void","minecraft:deny","minecraft:allow","minecraft:redstone_wire","hfrlc:barrier_collision","hfrlc:barrier_collision2","hfrlc:dungeon_door_desert","hfrlc:dungeon_door","hfrlc:dungeon_door_key","hfrlc:dungeon_door_snow","hfrlc:dungeon_door_red_desert","hfrlc:key","minecraft:mob_spawner","minecraft:trial_spawner","hfrlc:golem_spawner","minecraft:water","minecraft:lava","minecraft:flowing_water","minecraft:flowing_lava"];export function events(e,t){if(e&&"hfrlc:death_knight"===e.typeId)switch(t){case"hfrlc:melee":melee(e);break;case"hfrlc:spin_attack":spinAttack(e);break;case"hfrlc:start_emote":emote(e)}}function melee(e){const t=e.dimension;let r=e.getProperty("hfrlc:states")??"none";system.runTimeout(()=>{if(e?.isValid()&&(r=e.getProperty("hfrlc:states")??"none","melee"===r)){const r=t.getEntities({location:Vector.getLocalCoords(e,{z:2}),maxDistance:3,excludeFamilies:["inanimate","monster"]});for(const t of r){if(!t||!anyType.includes(t.typeId))continue;const r=Vector.normalize(Vector.subtract(t.location,e.location));t.applyDamage(8,{cause:"entityAttack",damagingEntity:e}),"minecraft:player"===t.typeId?t.applyKnockback(r.x,r.z,3,.3):t.applyImpulse({x:2*r.x,y:0,z:2*r.z})}}},13),system.runTimeout(()=>{e?.isValid()&&(r=e.getProperty("hfrlc:states")??"none","melee"===r&&e.triggerEvent("hfrlc:stop_attack"))},31)}function spinAttack(e){const t=e.dimension;let r=e.getProperty("hfrlc:states")??"none",n=e.getProperty("hfrlc:emoting")??!1;system.runTimeout(()=>{if(e?.isValid()&&(r=e.getProperty("hfrlc:states")??"none",n=e.getProperty("hfrlc:emoting")??!1,"spin_attack"===r&&!n)){const o=system.runInterval(()=>{if(e?.isValid())if(r=e.getProperty("hfrlc:states")??"none",n=e.getProperty("hfrlc:emoting")??!1,"spin_attack"!==r||n)system.clearRun(o),e.triggerEvent("hfrlc:stop_attack");else{const r=[new Vector(3,-1,3),new Vector(-3,-1,3)],n=t.getEntities({location:Vector.getLocalCoords(e,{z:2}),maxDistance:3,excludeFamilies:["inanimate","monster"]});for(const t of n){if(!t||!anyType.includes(t.typeId))continue;const r=e.getViewDirection();t.applyDamage(6,{cause:"entityAttack",damagingEntity:e}),"minecraft:player"===t.typeId?t.applyKnockback(r.x,r.z,1.5,.2):t.applyImpulse({x:1.5*r.x,y:0,z:1.5*r.z})}system.run(async()=>{for(const n of r)for(let r=-1;r<4;r++){const o=Vector.getLocalCoordsXZ(e,{x:n.x,y:r,z:n.z}),c=t.getBlock(o);c&&!bannedBlocks.includes(c.typeId)&&"minecraft:air"!==c.typeId&&(t.runCommand(`execute positioned ${c.location.x} ${c.location.y} ${c.location.z} run setblock ~ ~ ~ air destroy`),await system.waitTicks(1))}})}else system.clearRun(o),e.triggerEvent("hfrlc:stop_attack")},5);system.runTimeout(()=>{e?.isValid()&&system.clearRun(o)},100)}},20),system.runTimeout(()=>{e?.isValid()&&(r=e.getProperty("hfrlc:states")??"none",n=e.getProperty("hfrlc:emoting")??!1,"spin_attack"!==r||n||e.triggerEvent("hfrlc:stop_attack"))},140),system.runTimeout(()=>{e?.isValid()&&e.removeTag("hfrlc:spin_attack_cooldown")},640)}export function onKill(e,t){e&&"hfrlc:death_knight"===e.typeId&&system.runTimeout(()=>{e?.isValid()&&"minecraft:player"===t.typeId&&(e.triggerEvent("hfrlc:emote"),e.setDynamicProperty("hfrlc:deadEntity_loc",`${JSON.stringify(t.location)}`))},10)}function emote(e){const t=JSON.parse(e.getDynamicProperty("hfrlc:deadEntity_loc")),r=e.getRotation().y;let n=e.getProperty("hfrlc:emoting")??!1,o=0;e.teleport(e.location,{facingLocation:t}),e.setDynamicProperty("hfrlc:deadEntity_loc",void 0);const c={isValid:()=>!0,getRotation:()=>({x:0,y:r,z:0}),location:t},a=system.runInterval(()=>{if(e?.isValid())if(n=e.getProperty("hfrlc:emoting")??!1,o+=.1,n){let t=Math.cos(o);const r=8*Math.abs(t),n=Vector.getLocalCoordsXZ(c,{x:t});e.applyKnockback(n.localX,n.localZ,r,0)}else system.clearRun(a);else system.clearRun(a)},2);system.runTimeout(()=>{e?.isValid()&&(n=e.getProperty("hfrlc:emoting")??!1,n&&e.triggerEvent("hfrlc:stop_emote"))},160)}