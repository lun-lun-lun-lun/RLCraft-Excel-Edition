import{world,system}from"@minecraft/server";import{secondsToTicks,randInt}from"./libs/utils";import{bVector3}from"./libs/better_vectors";export const DATA={id:"hfrlc:dead_shooter",arrow_id:"hfrlc:deadshooter_arrow",states:{none:"none",targeting:"targeting",charging:"charging",attacking:"attacking",rolling:"rolling",running:"running"},rolling:{jump_strength:1,run_chance:.6,min_distance:10,fail_chance:.05,stuck_cycles_min:2,stuck_cycles_max:4,jump_delay:secondsToTicks(.15),second_jump_delay:secondsToTicks(.5),success_anim_length:secondsToTicks(1.21),fail_anim_length:secondsToTicks(1.83),fail_idle_anim_length:secondsToTicks(1.08),cooldown_time:secondsToTicks(.5),stuck_cooldown_time:secondsToTicks(1)},running:{run_speed:.35,run_interval:1,stop_distance:10,jump_up_strength:.5,gravity:-.5,cooldown_time:secondsToTicks(.5)},attacking:{min_distance:15,charge_time:secondsToTicks(1.0037),shoot_time:secondsToTicks(.88),cooldown_time:secondsToTicks(.5),arrow_ground_offset:1.5,arrow_speed:2.75}};export async function tick(t){if(!t.getProperty("hfrlc:dead"))if(t.getProperty("hfrlc:state")!==DATA.states.rolling&&t.getProperty("hfrlc:state")!==DATA.states.running)if(t.getProperty("hfrlc:has_target")){let e=t.getDynamicProperty("hfrlc:target");if(e)e=world.getEntity(t.getDynamicProperty("hfrlc:target"));else{const r=await getTarget(t);r?(e=r,t.setDynamicProperty("hfrlc:target",r.id)):t.setProperty("hfrlc:can_roll",!1)}let r=detectWall(t,e);if(e){let o=bVector3.fromVector3(e.location),n=bVector3.fromVector3(t.location);bVector3.distance(o,n)<=DATA.rolling.min_distance&&!r?t.setProperty("hfrlc:can_roll",!0):(t.setProperty("hfrlc:can_roll",!1),bVector3.distance(o,n)>DATA.attacking.min_distance?t.getProperty("hfrlc:can_attack")&&t.triggerEvent("hfrlc:disable_attack"):bVector3.distance(o,n)<=DATA.attacking.min_distance&&!t.getProperty("hfrlc:can_attack")&&(t.triggerEvent("hfrlc:enable_attack"),t.triggerEvent("hfrlc:movement_on")))}if(e){let r=getDirection(e,t).angles().theta;t.setRotation({x:0,y:r}),t.setProperty("hfrlc:rotation",r),t.setProperty("hfrlc:rotation_locked",!0)}if(t.getProperty("hfrlc:can_roll")&&e&&t.isOnGround&&!t.isInWater&&!t.getProperty("hfrlc:stuck")&&!t.getDynamicProperty("hfrlc:roll_on_cooldown"))if(Math.random()>DATA.rolling.run_chance&&!r){t.triggerEvent("hfrlc:start_roll"),t.setDynamicProperty("hfrlc:roll_on_cooldown",!0),t.setDynamicProperty("hfrlc:shooting_in_progress",!1);let r=getDirection(e,t);Math.random()<=DATA.rolling.fail_chance&&!t.getProperty("hfrlc:stuck")?(t.setProperty("hfrlc:stuck",!0),system.runTimeout(()=>{r.normalize(),r.multiply(-DATA.rolling.jump_strength),t.applyImpulse(r)},DATA.rolling.jump_delay),system.runTimeout(()=>{t?.isValid()&&(t?.setProperty("hfrlc:stuck",!1),t?.triggerEvent("hfrlc:end_roll"),system.runTimeout(()=>{t&&t?.isValid()&&(t.setDynamicProperty("hfrlc:roll_on_cooldown",!1),t?.triggerEvent("hfrlc:movement_on"))},DATA.rolling.stuck_cooldown_time))},DATA.rolling.fail_anim_length+randInt(DATA.rolling.stuck_cycles_min,DATA.rolling.stuck_cycles_max)*DATA.rolling.fail_idle_anim_length)):(system.runTimeout(()=>{let r=getDirection(e,t);t.setRotation({x:0,y:r.angles().theta}),t.setProperty("hfrlc:rotation",r.angles().theta),r.normalize(),r.multiply(-DATA.rolling.jump_strength),t.applyImpulse(r)},DATA.rolling.jump_delay),system.runTimeout(()=>{t.clearVelocity();let r=getDirection(e,t);t.setRotation({x:0,y:r.angles().theta}),t.setProperty("hfrlc:rotation",r.angles().theta),r.normalize(),r.multiply(-DATA.rolling.jump_strength),t.applyImpulse(r)},DATA.rolling.second_jump_delay),system.runTimeout(()=>{t?.isValid()&&(t?.setProperty("hfrlc:stuck",!1),t?.triggerEvent("hfrlc:end_roll"),system.runTimeout(()=>{t.setDynamicProperty("hfrlc:roll_on_cooldown",!1)},DATA.rolling.cooldown_time))},DATA.rolling.success_anim_length))}else if(!r){t.triggerEvent("hfrlc:start_run"),t.setDynamicProperty("hfrlc:roll_on_cooldown",!0),t.setDynamicProperty("hfrlc:shooting_in_progress",!1);let r=system.runInterval(()=>{let o=getDirection(e,t);o.multiply(-1),(o.magnitude()>=DATA.running.stop_distance||t.getDynamicProperty("hfrlc:ending_roll"))&&(system.clearRun(r),t.setDynamicProperty("hfrlc:ending_roll",!1),t?.setProperty("hfrlc:stuck",!1),t?.triggerEvent("hfrlc:end_run"),t?.clearVelocity(),system.runTimeout(()=>{t.setDynamicProperty("hfrlc:roll_on_cooldown",!1)},DATA.running.cooldown_time)),o.setMagnitude(DATA.running.run_speed),t.clearVelocity();let n=t.dimension.getBlockFromRay(t.location,o,{includeLiquidBlocks:!1,includePassableBlocks:!1,maxDistance:1});if(n&&n.block&&n.block.isValid()){let t=n.block.above();t&&t.isValid()&&(t.isAir||t.isLiquid||(o.y=DATA.running.jump_up_strength))}let i=t.dimension.getBlockFromRay(t.location,{x:0,y:-1,z:0},{includeLiquidBlocks:!1,includePassableBlocks:!1,maxDistance:5});if(i&&i.block&&i.block.isValid()){let e=bVector3.fromVector3(i.block.location);e.y=Math.floor(e.y)+1;let r=bVector3.fromVector3(t.location);bVector3.distance(r,e)>=1&&(o.y=DATA.running.gravity)}t.applyImpulse(o)},DATA.running.run_interval)}if(t.getProperty("hfrlc:state")===DATA.states.targeting&&(distanceToTarget(t,e)<=DATA.attacking.min_distance||r)&&e&&t.isOnGround&&t.getProperty("hfrlc:can_attack")&&t.getProperty("hfrlc:has_target")&&!t.getDynamicProperty("hfrlc:roll_on_cooldown")&&!t.getDynamicProperty("hfrlc:shooting_in_progress")&&t.getProperty("hfrlc:can_attack")){t.triggerEvent("hfrlc:state_charging"),t.setDynamicProperty("hfrlc:shooting_in_progress",!0);let r=getDirection(e,t);t.setRotation({x:0,y:r.angles().theta}),system.runTimeout(()=>{if(t&&t?.isValid()&&t?.getProperty("hfrlc:state")!==DATA.states.rolling&&t?.getProperty("hfrlc:state")!==DATA.states.running&&t.getProperty("hfrlc:has_target")){let r=getDirection(e,t),o=r.copy();o.normalize();let n=bVector3.fromVector3(t.location);n.add(o),n.y+=DATA.attacking.arrow_ground_offset;const i=t.dimension.spawnEntity(DATA.arrow_id,n);i.setProperty("hfrlc:rotation_y",r.angles().phi),i.setProperty("hfrlc:rotation_x",r.angles().theta),i.setDynamicProperty("hfrlc:owner",t.id),r.normalize(),r.multiply(DATA.attacking.arrow_speed);const l=i.getComponent("minecraft:projectile");l?.shoot(r),t?.setProperty("hfrlc:state",DATA.states.attacking)}else t?.triggerEvent("hfrlc:enable_attack"),t.setDynamicProperty("hfrlc:shooting_in_progress",!1);system.runTimeout(()=>{t&&t?.isValid()&&(t?.getProperty("hfrlc:state")!==DATA.states.rolling&&t?.getProperty("hfrlc:state")!==DATA.states.running&&t.getProperty("hfrlc:has_target")?(t?.triggerEvent("hfrlc:state_targeting"),system.runTimeout(()=>{t&&t?.isValid()&&(t?.getProperty("hfrlc:state")!==DATA.states.rolling&&t?.getProperty("hfrlc:state")!==DATA.states.running&&t.getProperty("hfrlc:has_target")?(t?.triggerEvent("hfrlc:enable_attack"),t.setDynamicProperty("hfrlc:shooting_in_progress",!1)):(t?.getProperty("hfrlc:state")!==DATA.states.rolling&&t?.getProperty("hfrlc:state")!==DATA.states.running&&t?.triggerEvent("hfrlc:state_none"),t?.triggerEvent("hfrlc:enable_attack"),t.setDynamicProperty("hfrlc:shooting_in_progress",!1)))},DATA.attacking.cooldown_time)):(t?.getProperty("hfrlc:state")!==DATA.states.rolling&&t?.getProperty("hfrlc:state")!==DATA.states.running&&t?.triggerEvent("hfrlc:state_none"),t?.triggerEvent("hfrlc:enable_attack"),t.setDynamicProperty("hfrlc:shooting_in_progress",!1)))},DATA.attacking.shoot_time)},DATA.attacking.charge_time)}}else t.setProperty("hfrlc:rotation_locked",!1);else{let e=t.getDynamicProperty("hfrlc:target");if(e)e=world.getEntity(t.getDynamicProperty("hfrlc:target"));else{const r=await getTarget(t);r?(e=r,t.setDynamicProperty("hfrlc:target",r.id)):t.setProperty("hfrlc:can_roll",!1)}detectWall(t,e)&&(t.getProperty("hfrlc:state")===DATA.states.rolling?t.triggerEvent("hfrlc:end_roll"):t.getProperty("hfrlc:state")===DATA.states.running&&t.triggerEvent("hfrlc:end_run"),t.setDynamicProperty("hfrlc:ending_roll",!0),t.setProperty("hfrlc:can_roll",!1),t.triggerEvent("hfrlc:enable_attack"),t.triggerEvent("hfrlc:movement_on"))}}export function onEvent(t){t.entity.typeId===DATA.id&&("hfrlc:no_target"===t.eventId&&t.entity&&t.entity?.isValid()&&t.entity?.setDynamicProperty("hfrlc:target",void 0),"hfrlc:death"===t.eventId&&t.entity&&t.entity?.isValid()&&!t.entity.getProperty("hfrlc:rotation_locked")&&(t.entity.setProperty("hfrlc:rotation",t.entity.getRotation().y),t.entity.setProperty("hfrlc:rotation_locked",!0)))}function detectWall(t,e){let r=!1,o=getDirection(t,e);o.y=0;let n=bVector3.fromVector3(t.location);n.y=Math.floor(n.y)+1.5;let i=t.dimension.getBlockFromRay(n.toVector3(),o,{includeLiquidBlocks:!1,includePassableBlocks:!1,maxDistance:2});return i&&i.block&&i.block.isValid()&&(i.block.isAir||i.block.isLiquid||(r=!0)),r}function getDirection(t,e){let r=bVector3.fromVector3(t.location),o=bVector3.fromVector3(e.location);return bVector3.subtract(r,o)}function distanceToTarget(t,e){let r=bVector3.fromVector3(t.location),o=bVector3.fromVector3(e.location);return bVector3.distance(r,o)}function getTarget(t){let e=!1;if(void 0!==t&&t?.isValid())return new Promise(r=>{t.triggerEvent("hfrlc:get_target");const o=system.afterEvents.scriptEventReceive.subscribe(t=>{if("hfrlc:get_target"===t.id)return e=!0,system.afterEvents.scriptEventReceive.unsubscribe(o),void r(t.sourceEntity)});system.runTimeout(()=>{system.afterEvents.scriptEventReceive.unsubscribe(o),e||r(null)},20)})}