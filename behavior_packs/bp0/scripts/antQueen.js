import{Entity,system,world}from"@minecraft/server";import{Vector}from"./vector";import{getPositionsInRadius}from"./functions.js";const JUMP_DAMAGE=18;export function events(t,e){if("hfrlc:ant_queen"!==t.typeId&&"hfrlc:little_ant"!==t.typeId)return;const n=t.dimension;if("hfrlc:on_init"===e){const e=10*Math.random()+10,o=system.runInterval(()=>{if(t?.isValid()){const e=n.getEntitiesFromRay(Vector.add(t.location,{x:0,y:1,z:0}),{x:0,y:-1,z:0},{type:"hfrlc:little_ant",maxDistance:2})[0];if(e){const n=t.getProperty("hfrlc:states")??"none",o=e.entity;if(o&&"jump"!==n&&"summon"!==n){const e=Vector.getLocalCoords(o,{x:1,y:0,z:0});t.tryTeleport(Vector.add(t.location,{x:0,y:-1,z:0}),{checkForBlocks:!0,keepVelocity:!0}),o.tryTeleport(e,{checkForBlocks:!0,keepVelocity:!0})}}}else system.clearRun(o)},e)}if("hfrlc:little_ant"===t.typeId&&"hfrlc:death"===e){const e=t.getDynamicProperty("hfrlc:antQueenOwner")??null;if(!e)return;const n=world.getEntity(e);if(!n)return;const o=n.getDynamicProperty("hfrlc:antMinions")??0;n.setDynamicProperty("hfrlc:antMinions",Math.max(o-1,0))}if("hfrlc:ant_queen"===t.typeId&&("hfrlc:jump"===e&&(system.runTimeout(()=>{if(t?.isValid()){const e=n.getPlayers({location:t.location,maxDistance:60,closest:1})[0],o=e.location.x-t.location.x,i=e.location.z-t.location.z,r=e.location.y-t.location.y,s=Math.sqrt(o*o+i*i),c=2*Math.sqrt(s),a={x:o/c,y:(r+s)/(1.2*c),z:i/c};t.applyImpulse(a);const l=system.runInterval(()=>{if(t?.isValid()||system.clearRun(l),t.isOnGround){const e=n.getEntities({location:t.location,maxDistance:3});for(const n of e){if("minecraft:player"!==n.typeId&&"hfrlc:little_ant"!==n.typeId)continue;const e=Vector.normalize(Vector.subtract(t.location,n.location));n.applyKnockback(e.x,e.z,-4,.3),"minecraft:player"===n.typeId&&n.applyDamage(18,{cause:"entityAttack",damagingEntity:t})}system.runTimeout(()=>{t?.isValid()&&t.triggerEvent("hfrlc:stop_attack")},16),system.clearRun(l)}},1)}},12),system.runTimeout(()=>{t?.isValid()&&t.removeTag("hfrlc:jump_attack_cooldown")},300)),"hfrlc:summon"===e)){system.runTimeout(()=>{if(t?.isValid()){const e=getPositionsInRadius(n,t.location,4,6),o=t.getRotation();for(let i=0;i<5;i++){const r=Array.from(e)[i],s=n.spawnEntity("hfrlc:little_ant<minecraft:entity_born>",r);s.setRotation(o);let c=t.getDynamicProperty("hfrlc:antMinions")??0;c++,t.setDynamicProperty("hfrlc:antMinions",c),s.setDynamicProperty("hfrlc:antQueenOwner",`${t.id}`)}}},35),system.runTimeout(()=>{t?.isValid()&&t.triggerEvent("hfrlc:stop_attack")},66);const e=t.getDynamicProperty("hfrlc:summon_uses")??0;e<2&&(t.setDynamicProperty("hfrlc:summon_uses",e+1),system.runTimeout(()=>{if(t?.isValid()){let e=t.getDynamicProperty("hfrlc:antMinions")??0;if(e&&0!==e){const n=system.runInterval(()=>{t?.isValid()?(e=t.getDynamicProperty("hfrlc:antMinions")??0,e&&0!==e||(system.clearRun(n),system.runTimeout(()=>{t?.isValid()&&t.removeTag("hfrlc:summon_cooldown")},40))):system.clearRun(n)},10)}else t.removeTag("hfrlc:summon_cooldown")}},600))}}