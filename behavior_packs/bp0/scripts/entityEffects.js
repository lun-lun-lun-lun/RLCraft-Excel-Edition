import{system,EntityEquippableComponent,EquipmentSlot,MolangVariableMap}from"@minecraft/server";import{addEffect}from"./functions.js";export function entityEffect(e,t,n){if(!e)return;e.typeId.includes("wyvern")&&t.addTag("target");const r={"hfrlc:little_ant":[["hunger",40,3]],"hfrlc:spider_king":[["fatal_poison",40,3]],"hfrlc:dwarf_king":[["weakness",40,3],["poison",40,3]],"hfrlc:pirate_king":[["slowness",40,3],["poison",40,3]],"hfrlc:orc_boss":[["wither",40,3],["slowness",40,3]],"hfrlc:knight_king":[["wither",40,3],["weakness",40,3]],"hfrlc:god_boss":[["slowness",40,3],["weakness",40,3]],"hfrlc:snake":[["fatal_poison",40,0]],"hfrlc:divine_warrior":[["wither",40,0]]}[e.typeId];if(r)for(const[e,n,o]of r)addEffect(t,e,n,o,!0);switch(e.typeId){case"hfrlc:ancient_titan":e.hasTag("thunder")?system.runTimeout(()=>{t.dimension.spawnEntity("minecraft:lightning_bolt",t.location),e.removeTag("thunder")},5):system.runTimeout(()=>e.addTag("thunder"),5);break;case"hfrlc:djinn":(n=Math.floor(100*Math.random())+1)<21?addEffect(t,"poison",40,0,!0):n<61&&t.setOnFire(5,!0);break;case"hfrlc:divine_warrior":(n=Math.floor(100*Math.random())+1)<71&&addEffect(t,"blindness",40,0,!0)}}export function entityTiers(e){if("function"!=typeof e.getProperty||void 0===e.getProperty("hfrlc:mob_tier"))return;const t=e.dimension.getPlayers({location:e.location,maxDistance:72,closest:1})[0];if(!t)return;const n=t.getProperty("hfrlc:power_level"),r=e.getComponent("minecraft:type_family")?.hasTypeFamily("boss"),o=Math.random(),a=[{min:50,max:150,bossTier:"hfrlc:mob_tier1",nonBossChances:[{threshold:.05,event:"hfrlc:mob_tier1"}]},{min:151,max:300,bossTier:"hfrlc:mob_tier2",nonBossChances:[{threshold:.075,event:"hfrlc:mob_tier1"},{threshold:.1,event:"hfrlc:mob_tier2"}]},{min:301,max:400,bossTier:"hfrlc:mob_tier3",nonBossChances:[{threshold:.05,event:"hfrlc:mob_tier1"},{threshold:.075,event:"hfrlc:mob_tier2"},{threshold:.125,event:"hfrlc:mob_tier3"}]}];for(const t of a)if(n>=t.min&&n<=t.max){if(r)e.triggerEvent(t.bossTier);else{let n=0;for(const r of t.nonBossChances)if(n+=r.threshold,o<n){e.triggerEvent(r.event);break}}break}}let effectColors=[{red:1,green:1,blue:1},{red:1,green:1,blue:1},{red:1,green:84/255,blue:84/255},{red:137/255,green:167/255,blue:47/255},{red:139/255,green:98/255,blue:147/255},{red:1,green:170/255,blue:0},{red:0,green:170/255,blue:170/255},{red:0,green:160/255,blue:1},{red:98/255,green:238/255,blue:1},{red:249/255,green:107/255,blue:192/255},{red:1,green:1,blue:1}];export function damageIndicator(e,t,n,r){let o=10;if(o={freezing:8,wither:4,lightning:7}[t]??10,t.includes("fire")&&(o=5),e.typeId.includes("hfrlc:wyvern_")){const e=r?.getComponent(EntityEquippableComponent.componentId)?.getEquipment(EquipmentSlot.Mainhand);e?.typeId.includes("dragon_bone_")&&(o=6)}"function"==typeof e.getEffect&&["poison","fatal_poison"].some(t=>e.getEffect(t))&&(o=3),e.hasTag("damage_indicator_m")&&(e.removeTag("damage_indicator_m"),o=0),e.hasTag("damage_indicator_s")&&(e.removeTag("damage_indicator_s"),o=1),"minecraft:player"===r?.typeId&&r.isFalling&&(o=2);let a={x:e.location.x+1*Math.random()-.5,y:e.location.y+1.5,z:e.location.z+1*Math.random()-.5};try{spawnDamageParticles(n,o,a,e.dimension)}catch(e){}}function spawnDamageParticles(e,t,n,r){const o=r.getPlayers({location:n,maxDistance:72,excludeTags:["desactive_damage_indicator"]});if(!o.length)return;const a=.15,i=effectColors[t];let s;if(e<20)s=18.9,spawnNumberParticles(o,a,i,n,e,5);else if(e<100)s=21.1,spawnNumberParticles(o,a,i,n,Math.floor(e/10),7),spawnNumberParticles(o,a,i,n,e%10,2);else{s=25.9;const t=String(e).padStart(3,"0").slice(0,3).split("").map(Number),r=[10,5,0];t.forEach((e,t)=>{spawnNumberParticles(o,a,i,n,e,r[t])})}10!==t&&spawnEffectParticle(o,a,n,s,t)}function spawnNumberParticles(e,t,n,r,o,a){const i=new MolangVariableMap;i.setFloat("digit",o),i.setFloat("digitoffset",a),i.setFloat("scale",t),i.setColorRGB("col",n);for(const t of e)t.dimension.spawnParticle("hfrlc:dmg_number",r,i)}function spawnEffectParticle(e,t,n,r,o){const a=new MolangVariableMap;a.setFloat("offset",r),a.setFloat("type",o),a.setFloat("scale",t);for(const t of e)t.dimension.spawnParticle("hfrlc:dmg_type",n,a)}