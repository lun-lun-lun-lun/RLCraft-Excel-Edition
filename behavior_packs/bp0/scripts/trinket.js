import{system,world,EntityEquippableComponent,EquipmentSlot,ItemStack}from"@minecraft/server";import{addEffect,getScore,removeEffect,setScore}from"./functions.js";export function trinketEvents(e,t){switch(t){case"hfrlc:dead_trinket":(world.gameRules.keepInventory||world.isHardcore)&&despawn_trinket_menu(e);break;case"hfrlc:trinketEffects":const a=e.dimension.getEntities({type:"hfrlc:trinket_menu",tags:[e.name]});for(const t of a)Trinketeffects(t,e);break;case"hfrlc:trinketHold":holdTrinket(e),applyHandEffects(e);break;default:const n={"hfrlc:dragon_slayer_cape":["poison","fatal_poison","slowness","mining_fatigue","blindness","wither","levitation"],"hfrlc:antidote_vital":["poison","fatal_poison"],"hfrlc:ancient_root":["slowness"],"hfrlc:goat_horns":["mining_fatigue"],"hfrlc:cyclops_eye":["blindness","darkness"],"hfrlc:dragon_eyes":["darkness"],"hfrlc:blessed_water":["wither"],"hfrlc:shulker_anchor":["levitation"]}[t];if(n)for(const t of n)removeEffect(e,t)}}export function add_trinket(e,t,a){const n=e.getTags(),o=e.getViewDirection();fix_trinket(e,n,o,e.location);const[s]=e.dimension.getEntities({type:"hfrlc:trinket_menu",tags:[e.name]}),i=s?.getComponent("inventory")?.container;i&&i.setItem(a,new ItemStack(t))}export function despawn_trinket(e){e.getTags().forEach(t=>{t.startsWith('{"trinkets":{')&&e.removeTag(t)});const t=e.dimension.getEntities({type:"hfrlc:trinket_menu",tags:[`${e.name}`]});for(const e of t)e.remove()}export function despawn_trinket_menu(e){const t=e.dimension.getEntities({type:"hfrlc:trinket_menu",tags:[`${e.name}`]});for(const e of t)e.remove()}function Trinketeffects(e,t){detectItemsInvTrinket(t,e),applyDragonSlayerEffects(t,e),applyRingEffects(t,e),applySpeedAndFeatherEffects(t,e),armorTrinketCombinet(e,t),applyShieldEffects(t,e)}function detectItemsInvTrinket(e,t){const a=t.getComponent("inventory").container;itemsToTags.forEach(({item:n,tag:o,slots:s})=>{const i="3..5"===s,r=i?[3,4,5]:[0,1,2],c=i?[0,1,2]:[3,4,5];for(const t of c){const o=a.getItem(t);o?.typeId===n&&(a.setItem(t),e.runCommandAsync(`give @s ${n} 1`),e.playSound("random.no_options"))}let g=!1;for(const t of r){const o=a.getItem(t);o?.typeId===n&&(g?(a.setItem(t),e.runCommandAsync(`give @s ${n} 1`),e.playSound("random.no_options"),e.sendMessage({translate:"action.duplicate_trinket"})):g=!0)}const d=`tag @s[hasitem={item=${n},slot=${s},location=slot.inventory,quantity=0}] remove ${o}`,l=`tag @s[hasitem={item=${n},slot=${s},location=slot.inventory}] add ${o}`;t.hasTag(o)?t.runCommandAsync(d):t.runCommandAsync(l)})}function holdTrinket(e){const t=e.getTags(),a=e.getViewDirection(),n=e.location,o=e.dimension.getEntities({type:"hfrlc:trinket_menu",tags:[`${e.name}`]}),s=e.getComponent(EntityEquippableComponent.componentId).getEquipment(EquipmentSlot.Mainhand);if(!s||s&&"hfrlc:trinket_menu"!==s.typeId){for(const s of o){handleEffectsAndTags(s,e),applyMiningAmuletEffects(e,s);const o=s.getComponent("inventory").container;for(let s=0;s<o.size;s++){const i=o.getItem(s);if(t.forEach(t=>{if(t.startsWith('{"trinkets":{')){const a=JSON.parse(t).trinkets.slot;null==i&&a==s&&e.removeTag(t)}}),i){if(i.hasTag("hfrlc:is_trinket")){const t={trinkets:{id:`${i.typeId}`,slot:`${s}`}};e.hasTag(JSON.stringify(t))||e.addTag(JSON.stringify(t))}if(!i.hasTag("hfrlc:is_trinket")){const t=e.getComponent("inventory").container,r=new ItemStack("minecraft:air");o.setItem(s,r),0==o.emptySlotsCount&&e.dimension.spawnItem(i,{x:n.x+a.x,y:n.y+2,z:n.z+a.z}),o.emptySlotsCount>0&&t.addItem(i)}}}s.teleport({x:n.x+a.x+4,y:n.y+a.y+8,z:n.z+a.z+4})}e.removeTag("spawn_trinket"),e.removeTag("despawn_trinket")}s&&"hfrlc:trinket_menu"==s.typeId&&fix_trinket(e,t,a,n)}export function fix_trinket(e,t,a,n){if(!e.hasTag("spawn_trinket")&&(e.hasTag("despawn_trinket")||(despawn_trinket_menu(e),e.addTag("despawn_trinket")),e.hasTag("despawn_trinket"))){let t=e.dimension.spawnEntity("hfrlc:trinket_menu",{x:Math.floor(e.location.x),y:Math.floor(e.location.y),z:Math.floor(e.location.z)});t.addTag(`${e.name}`),t.nameTag="Trinket",t.getComponent("tameable").tame(e),e.getTags().forEach(e=>{if(e.startsWith('{"trinkets":{')){let a=JSON.parse(e).trinkets.id,n=JSON.parse(e).trinkets.slot,o=t.getComponent("inventory").container,s=new ItemStack(`${a}`);o.setItem(parseFloat(n),s)}}),e.addTag("spawn_trinket")}let o=e.dimension.getEntities({type:"hfrlc:trinket_menu",tags:[`${e.name}`]});for(let s of o){handleEffectsAndTags(s,e),Trinketeffects(s,e),applyMiningAmuletEffects(e,s);const o=s.getComponent("inventory").container;for(let s=0;s<o.size;s++){const i=o.getItem(s);if(t.forEach(t=>{if(t.startsWith('{"trinkets":{')){const a=JSON.parse(t).trinkets.slot;null==i&&a==s&&e.removeTag(t)}}),i){if(i.hasTag("hfrlc:is_trinket")){const t={trinkets:{id:`${i.typeId}`,slot:`${s}`}};e.hasTag(JSON.stringify(t))||e.addTag(JSON.stringify(t))}if(!i.hasTag("hfrlc:is_trinket")){const t=e.getComponent("inventory").container,r=new ItemStack("minecraft:air");o.setItem(s,r),0==o.emptySlotsCount&&e.dimension.spawnItem(i,{x:n.x+a.x,y:n.y+2,z:n.z+a.z}),o.emptySlotsCount>0&&t.addItem(i)}}}s.teleport({x:n.x+a.x,y:n.y+a.y+.5,z:n.z+a.z})}}function applySpeedAndFeatherEffects(e,t){const a=t.hasTag("feather_swiftness"),n=t.hasTag("ring_speed"),o=e.hasTag("level_speed10"),s=e.hasTag("pirate_armor_set"),i=o?1:0,r=s?1:0;if(s&&addEffect(e,"water_breathing",40,1,!1),o||!s||n||a){if(!n&&a){addEffect(e,"slow_falling",30,1,!1);return void addEffect(e,"speed",30,i+r+1,!1)}if(n&&!a){return void addEffect(e,"speed",30,i+r,!1)}if(n&&a){addEffect(e,"slow_falling",30,1,!1);return void addEffect(e,"speed",30,(o?3:2)+r,!1)}}else addEffect(e,"speed",40,0,!1)}function handleEffectsAndTags(e,t){[{condition:()=>!t.hasTag("goat_horns")&&e.hasTag("goat_horns")&&!t.hasTag("mining_item"),actions:()=>{t.addTag("goat_horns")}},{condition:()=>t.hasTag("goat_horns")&&(!e.hasTag("goat_horns")||t.hasTag("mining_item")),actions:()=>{t.removeTag("goat_horns")}},{condition:()=>!e.hasTag("great_horn_shield"),actions:()=>t.removeTag("great_horn")},{condition:()=>e.hasTag("great_horn_shield"),actions:()=>{t.addTag("great_horn"),t.triggerEvent("hfrlc:knockback_resistance"),t.addTag("knockback")}},{condition:()=>!e.hasTag("great_horn_shield")&&!e.hasTag("greatest_shield")&&!e.hasTag("dragon_slayer_cape"),actions:()=>t.removeTag("knockback")},{condition:()=>e.hasTag("greatest_shield"),actions:()=>{t.triggerEvent("hfrlc:knockback_resistance"),t.addTag("knockback")}},{condition:()=>e.hasTag("withering_necklace"),actions:()=>t.addTag("withering_necklace")},{condition:()=>!e.hasTag("withering_necklace"),actions:()=>t.removeTag("withering_necklace")},{condition:()=>e.hasTag("panacea"),actions:()=>{t.addTag("panacea")}},{condition:()=>!e.hasTag("panacea"),actions:()=>t.removeTag("panacea")},{condition:()=>e.hasTag("ice_bag"),actions:()=>{t.addTag("ice_bag"),t.removeTag("heat_damage"),getScore(t,"thermometer")>11e3&&setScore(t,"thermometer",11e3)}},{condition:()=>!e.hasTag("ice_bag"),actions:()=>t.removeTag("ice_bag")},{condition:()=>e.hasTag("warmer"),actions:()=>{t.addTag("warmer"),t.removeTag("snow_damage"),getScore(t,"thermometer")<1e3&&setScore(t,"thermometer",1e3)}},{condition:()=>!e.hasTag("warmer"),actions:()=>t.removeTag("warmer")},{condition:()=>e.hasTag("ancient_root"),actions:()=>{t.addTag("ancient")}},{condition:()=>!e.hasTag("ancient_root"),actions:()=>{t.removeTag("ancient")}},{condition:()=>e.hasTag("dragon_eyes"),actions:()=>{t.removeTag("night_vision"),t.addTag("dragon_eyes")}},{condition:()=>!e.hasTag("dragon_eyes"),actions:()=>{system.runTimeout(()=>t.removeTag("dragon_eyes"),2),t.hasTag("dragon_eyes")||t.hasTag("night_vision")||(removeEffect(t,"night_vision"),t.addTag("night_vision"))}},{condition:()=>e.hasTag("blessed_water"),actions:()=>t.addTag("blessed_water")},{condition:()=>!e.hasTag("blessed_water"),actions:()=>t.removeTag("blessed_water")},{condition:()=>e.hasTag("dragon_slayer_cape"),actions:()=>{t.addTag("dragon_slayer"),t.addTag("knockback"),t.triggerEvent("hfrlc:knockback_resistance"),t.triggerEvent("hfrlc:explosion_resistance")}},{condition:()=>!e.hasTag("dragon_slayer_cape"),actions:()=>{t.removeTag("dragon_slayer"),t.triggerEvent("hfrlc:normal_resistance")}},{condition:()=>e.hasTag("cyclops_eye"),actions:()=>{t.addTag("cyclops_eye")}},{condition:()=>!e.hasTag("cyclops_eye"),actions:()=>{t.removeTag("cyclops_eye")}},{condition:()=>e.hasTag("shulker_anchor"),actions:()=>t.addTag("shulker_anchor")},{condition:()=>!e.hasTag("shulker_anchor"),actions:()=>t.removeTag("shulker_anchor")},{condition:()=>e.hasTag("antidote_vital"),actions:()=>t.addTag("antidote_vital")},{condition:()=>!e.hasTag("antidote_vital"),actions:()=>t.removeTag("antidote_vital")}].forEach(({condition:e,actions:t})=>{e()&&t()})}function applyShieldEffects(e,t){const a={0:null,1:4,2:0,3:5,4:0,5:5,6:1,7:6}[(t.hasTag("greatest_shield")?1:0)<<2|(t.hasTag("great_horn_shield")?1:0)<<1|(t.hasTag("dragon_slayer_ring")?1:0)];null!==a&&addEffect(e,"health_boost",30,a,!1)}function applyEffectsBasedOnTags(e,t){t.forEach(e=>{e.condition()&&e.action()})}function armorTrinketCombinet(e,t){const a=t.getComponent(EntityEquippableComponent.componentId),n=["Head","Chest","Legs","Feet"],o=Object.fromEntries(n.map(e=>[e,a.getEquipment(EquipmentSlot[e])])),s=[{prefix:"pirate_",tag:"pirate_armor_set"},{prefix:"brown_dragon_",tag:"brown_armor_set"},{prefix:"dark_dragon_",tag:"dark_armor_set"},{prefix:"red_dragon_",tag:"red_armor_set"},{prefix:"blue_dragon_",tag:"blue_armor_set"},{prefix:"green_dragon_",tag:"green_armor_set"},{prefix:"samurai_",tag:"samurai_armor_set"}];if(n.every(e=>o[e])){const e=n.map(e=>o[e].typeId);for(const{prefix:a,tag:n}of s){e.every(e=>e.includes(a))?t.addTag(n):t.removeTag(n)}const a=["_dragon_helmet","_dragon_chestplate","_dragon_leggings","_dragon_boots"];e.every((e,t)=>e.includes(a[t]))?(t.addTag("dragon_armor_set"),t.hasTag("knockback")||t.triggerEvent("hfrlc:knockback1")):t.removeTag("dragon_armor_set")}else{const e=s.map(e=>e.tag).concat("dragon_armor_set");for(const a of e)t.removeTag(a)}}function applyRingEffects(e,t){const a=t.hasTag("ring_strength"),n=t.hasTag("ring_regeneration"),o=t.hasTag("teddy_of_comfort"),s=t.hasTag("ring_resistance"),i=t.hasTag("ring_jump"),r=t.hasTag("dragon_slayer_ring"),c=e.hasTag("darkness_sword"),g=e.hasTag("air"),d=e.hasTag("samurai_armor_set"),l=e.hasTag("dragon_armor_set");let f=null;a||r||!d?(a||r)&&(a&&!r?f=d?1:0:!a&&r?f=d?2:1:a&&r&&(f=d?3:2),null!==f&&addEffect(e,"strength",30,f,!1)):addEffect(e,"strength",40,0,!1);let _=null;s||r?(_=l?s&&r?2:1:s&&r?1:0,addEffect(e,"resistance",30,_,!1)):!l||a||r||addEffect(e,"resistance",40,0,!1);let m=null;if((n||o)&&(m=n&&o?1:0,addEffect(e,"regeneration",30,m,!1)),i){addEffect(e,"jump_boost",30,g||c?4:1,!1)}}function applyDragonSlayerEffects(e,t){const a=t.hasTag("dragon_slayer_cape"),n=t.hasTag("dragon_eyes"),o=e.hasTag("fire"),s=getScore(e,"melee")>=9;n&&addEffect(e,"night_vision",200,0,!1);let i=null;const r=o&&s,c=!o||!s;a&&n&&r?i=3:a&&!n&&r||!a&&n&&r?i=2:a&&n&&c?i=1:(a&&!n&&c||!a&&n&&c)&&(i=0),null!==i&&addEffect(e,"fire_resistance",30,i,!1)}function applyMiningAmuletEffects(e,t){if(!t.hasTag("mining_amulet"))return;const a=e.hasTag("level_mining10"),n=e.hasTag("obsidian");let o=0;a||n?a&&!n?o=2:a&&n&&(o=4):o=0,addEffect(e,"haste",20,o,!1)}function applyHandEffects(e){const t=e.getComponent(EntityEquippableComponent.componentId).getEquipment(EquipmentSlot.Mainhand);if(t){const a=t.typeId;["pickaxe","shovel","_axe"].some(e=>a.includes(e))?e.addTag("mining_item"):e.removeTag("mining_item");const n=getScore(e,"agility"),o=getScore(e,"melee");e.hasTag("darkness_sword")&&o>=14&&addEffect(e,"invisibility",10,2,!1),e.hasTag("water")&&o>=9&&(e.removeTag("desactive_water"),addEffect(e,"water_breathing",10,0,!1),addEffect(e,"conduit_power",200,1,!1));e.getTags().forEach(t=>{t.includes('{"trinkets":{"id":"hfrlc:ring_jump",')||(e.hasTag("air")&&n>=4&&addEffect(e,"jump_boost",10,2,!1),e.hasTag("darkness_sword")&&o>=14&&addEffect(e,"jump_boost",10,2,!1)),t.includes('{"trinkets":{"id":"hfrlc:dragon_eyes",')||t.includes('{"trinkets":{"id":"hfrlc:dragon_slayer_cape",')||e.hasTag("fire")&&n>=8&&addEffect(e,"fire_resistance",10,1,!1)})}else e.hasTag("mining_item")&&e.removeTag("mining_item")}const itemsToTags=[{item:"hfrlc:dragon_slayer_cape",tag:"dragon_slayer_cape",slots:"0..2"},{item:"hfrlc:dragon_eyes",tag:"dragon_eyes",slots:"0..2"},{item:"hfrlc:ring_strength",tag:"ring_strength",slots:"3..5"},{item:"hfrlc:ring_regeneration",tag:"ring_regeneration",slots:"3..5"},{item:"hfrlc:teddy_of_comfort",tag:"teddy_of_comfort",slots:"0..2"},{item:"hfrlc:ring_resistance",tag:"ring_resistance",slots:"3..5"},{item:"hfrlc:ring_jump",tag:"ring_jump",slots:"3..5"},{item:"hfrlc:ring_speed",tag:"ring_speed",slots:"3..5"},{item:"hfrlc:feather_swiftness",tag:"feather_swiftness",slots:"0..2"},{item:"hfrlc:greatest_shield",tag:"greatest_shield",slots:"0..2"},{item:"hfrlc:great_horn_shield",tag:"great_horn_shield",slots:"0..2"},{item:"hfrlc:mining_amulet",tag:"mining_amulet",slots:"0..2"},{item:"hfrlc:goat_horns",tag:"goat_horns",slots:"0..2"},{item:"hfrlc:panacea",tag:"panacea",slots:"0..2"},{item:"hfrlc:ancient_root",tag:"ancient_root",slots:"0..2"},{item:"hfrlc:blessed_water",tag:"blessed_water",slots:"0..2"},{item:"hfrlc:cyclops_eye",tag:"cyclops_eye",slots:"0..2"},{item:"hfrlc:shulker_anchor",tag:"shulker_anchor",slots:"0..2"},{item:"hfrlc:antidote_vital",tag:"antidote_vital",slots:"0..2"},{item:"hfrlc:warmer",tag:"warmer",slots:"0..2"},{item:"hfrlc:dragon_slayer_ring",tag:"dragon_slayer_ring",slots:"3..5"},{item:"hfrlc:ice_bag",tag:"ice_bag",slots:"0..2"},{item:"hfrlc:withering_necklace",tag:"withering_necklace",slots:"0..2"}];export function despawn_and_save_items(e){const t=[];return despawn_trinket_menu(e),e.getTags().forEach(a=>{if(a.startsWith('{"trinkets":{')){const n=JSON.parse(a).trinkets,o=n.id,s=parseInt(n.slot),i=new ItemStack(`${o}`);e.removeTag(a),e.removeTag("goat_horns");let r={typeId:i.typeId,count:i.amount,slot:s};t.push(r)}}),t}export function restoreTrinketItems(e,t){if(!t)return;const a=JSON.parse(t);if(!a.trinkets||0===a.trinkets.length)return;const n=e.dimension.getEntities({type:"hfrlc:trinket_menu",tags:[`${e.name}`]});for(const e of n){const t=e.getComponent("inventory").container;t.clearAll(),a.trinkets.forEach(e=>{const a=new ItemStack(e.typeId,e.count);e.slot>=0&&e.slot<t.size?t.setItem(e.slot,a):t.addItem(a)})}}