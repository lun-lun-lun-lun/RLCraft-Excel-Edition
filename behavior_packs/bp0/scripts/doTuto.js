import{system,world,EntityDamageCause,EntityEquippableComponent,EquipmentSlot,ItemStack,BlockVolume,GameMode}from"@minecraft/server";import{addScore,addEffect,setScore,getScore,addItem,itemCount,getRandomIntInRange,w}from"./functions.js";import{Durability,setToMaxDurability,giveSavedInventory}from"./itemsDamage.js";import{reactive_temp}from"./temp_sphere.js";import{reactive_thirst}from"./thirts.js";import{systemLevelReset}from"./system_level.js";import{add_trinket,despawn_trinket}from"./trinket.js";import{ActionFormData,ActionFormResponse,FormCancelationReason}from"@minecraft/server-ui";export function initial(t){const e=world.structureManager.get("mystructure:black_room_start"),a=getRandomIntInRange(-9999,9999),o=getRandomIntInRange(-9999,9999);t.teleport({x:a,y:-60,z:o},{rotation:{x:0,y:-6}}),world.structureManager.place(e,t.dimension,{x:t.location.x-6,y:-62,z:t.location.z-2}),t.setGameMode(GameMode.adventure),t.addTag("lens_active"),t.addTag("desactive_lens"),t.addTag("initial")}function showAddingPacksForm(t){(new ActionFormData).title({rawtext:[{translate:"action.guidebook.adding_packs2_title"},{text:"§q§f§f§r"}]}).button({translate:"action.guidebook.video_explaination_title"},"textures/ui/ServerUIcons/youtube.png").button({translate:"action.guidebook.add_aands_title"},"textures/ui/ServerUIcons/aands.png").button({translate:"action.guidebook.add_more_packs_title"},"textures/ui/ServerUIcons/adding_packs.png").button({translate:"action.guidebook.realms_disclaimer_title"},"textures/ui/ServerUIcons/realms.png").button({translate:"action.guidebook.play_title"}).show(t).then(e=>{if(e.canceled&&e.cancelationReason==FormCancelationReason.UserClosed)t.addTag("showAddingPacksForm");else switch(void 0!==e.selection&&t.addTag("showAddingPacksForm"),e.selection){case 0:(new ActionFormData).title({rawtext:[{translate:"action.guidebook.video_explaination_title"},{text:"§q§s"}]}).body({translate:"action.guidebook.video_explaination_body"}).button({translate:"action.guidebook.back"}).show(t).then(e=>{if(0===e.selection)showAddingPacksForm(t)});break;case 1:(new ActionFormData).title({translate:"action.guidebook.add_aands_title"}).body({translate:"action.guidebook.add_aands_body"}).button({translate:"action.guidebook.back"}).show(t).then(e=>{if(0===e.selection)showAddingPacksForm(t)});break;case 2:(new ActionFormData).title({translate:"action.guidebook.add_more_packs_title"}).body({translate:"action.guidebook.add_more_packs_body"}).button({translate:"action.guidebook.back"}).show(t).then(e=>{if(0===e.selection)showAddingPacksForm(t)});break;case 3:(new ActionFormData).title({translate:"action.guidebook.realms_disclaimer_title"}).body({translate:"action.guidebook.realms_disclaimer_body"}).button({translate:"action.guidebook.back"}).show(t).then(e=>{if(0===e.selection)showAddingPacksForm(t)});break}})}export function tutoEvent(t,e){"hfrlc:skip_tuto"==e&&initialKit(t)}function initialKit(t){t.setGameMode(GameMode.survival),addEffect(t,"resistance",200,255,!1),addEffect(t,"saturation",200,255,!1),addEffect(t,"instant_health",10,255,!1),t.triggerEvent("hfrlc:bodyparts_reset"),systemLevelReset(t),despawn_trinket(t),t.getComponent("inventory").container.clearAll();if(0===itemCount(t,"hfrlc:info_book")&&(addItem(t,"hfrlc:info_book",!0,"none"),!t.hasTag("skip_tuto")&&t.hasTag("did_tuto")||(addItem(t,"hfrlc:system_level",!0,"inventory"),addItem(t,"hfrlc:trinket_menu",!0,"inventory"),t.removeTag("skip_tuto"))),t.hasTag("did_tuto"))t.teleport({x:t.location.x,y:319,z:t.location.z}),t.resetLevel(),giveSavedInventory(t);else{"Easy"===world.getDifficulty()&&add_trinket(t,"hfrlc:teddy_of_comfort",0),t.teleport({x:0,y:319,z:0}),t.addTag("did_tuto")}t.addTag("start_game"),system.runTimeout(()=>{t.playSound("random.teleport"),t.removeTag("desactive_lens"),t.removeTag("lens_active")},2),system.runTimeout(()=>{t.removeTag("invesibility")},400),t.triggerEvent("hfrlc:bodyparts_active"),t.addTag("active_thirts"),t.addTag("active_temp"),t.addTag("active_bodypart"),reactive_thirst(t),t.getTags().forEach(e=>{e.includes("do_tuto")&&t.removeTag(e)})}system.runInterval(()=>{for(const t of world.getPlayers())t.hasTag("do_tuto0")&&tutuFunction(t),t.hasTag("showAddingPacksForm")||showAddingPacksForm(t)},40);let previousTags=[];function tutuFunction(t){if(t.hasTag("active_tuto11")){t.getSpawnPoint()&&t.addTag("do_tuto12")}const e=t.getComponent("inventory").container,a=t.getTags();if(n=a,(o=previousTags).length!==n.length||!o.every(t=>n.includes(t))||!n.every(t=>o.includes(t))){const e=a.filter(t=>!previousTags.includes(t)&&/^do_tuto\d+$/.test(t));e.length&&function(t,e){if(!e.hasTag("do_tuto0"))return;e.triggerEvent("hfrlc:black_room")}(0,t),previousTags=[...a]}var o,n;let s=new Map,r=null;function i(t){const e=t.getComponent("inventory").container,a=t.getComponent("cursor_inventory").item,o=[],n=new Map;for(let t=0;t<e.size;t++){const a=e.getItem(t);a&&n.set(t,{typeId:a.typeId,count:a.amount})}for(const[t,e]of n.entries()){const a=s.get(t);a?e.typeId===a.typeId&&e.count>a.count&&o.push({typeId:e.typeId,count:e.count-a.count}):o.push({typeId:e.typeId,count:e.count})}if(a){const t=r;t?a.typeId===t.typeId&&a.amount>t.amount&&o.push({typeId:a.typeId,count:a.amount-t.amount}):o.push({typeId:a.typeId,count:a.amount})}return s=n,r=a?{typeId:a.typeId,amount:a.amount}:null,o}for(let a=0;a<e.size;a++){const o=e.getItem(a);if(o){if("hfrlc:flint_dagger"!==o.typeId||t.hasTag("active_do_tuto7")||(t.addTag("active_do_tuto7"),system.runTimeout(()=>{t.addTag("do_tuto7")},5)),"hfrlc:plant_fibers_rope"!==o.typeId||t.hasTag("active_do_tuto8")||(t.addTag("active_do_tuto8"),system.runTimeout(()=>{t.addTag("do_tuto8")},5)),"hfrlc:flint_axe"!=o.typeId||t.hasTag("active_do_tuto9")||(t.addTag("active_do_tuto9"),system.runTimeout(()=>{t.addTag("do_tuto9")},5)),"hfrlc:goat_horns"==o.typeId&&t.hasTag("active_tuto26_2")&&system.runTimeout(()=>{t.addTag("do_tuto27")},5),t.hasTag("trinket_item")&&!t.hasTag("desactive_trinketItem")&&(t.addTag("desactive_trinketItem"),t.removeTag("trinket_item"),system.runTimeout(()=>{addItem(t,"hfrlc:trinket_menu",!0,"inventory")},5)),"minecraft:wooden_pickaxe"===o.typeId){if(itemCount(t,"minecraft:wooden_pickaxe")>1){t.runCommandAsync("clear @s minecraft:wooden_pickaxe 0 1"),e.addItem(new ItemStack("minecraft:stick",2)),e.addItem(new ItemStack("minecraft:oak_planks",3));break}t.hasTag("active_do_tuto16")||(t.addTag("active_do_tuto16"),system.runTimeout(()=>{t.hasTag("active_tuto16")||t.addTag("do_tuto16")},5))}if("hfrlc:flint_dagger"===o.typeId){if(itemCount(t,"hfrlc:flint_dagger")>1){t.runCommandAsync("clear @s hfrlc:flint_dagger 0 1"),e.addItem(new ItemStack("minecraft:stick")),e.addItem(new ItemStack("hfrlc:flint_shard"));break}}t.hasTag("system_level_item")&&!t.hasTag("desactive_event")&&(t.addTag("desactive_event"),addItem(t,"hfrlc:system_level",!0,"inventory"),t.removeTag("system_level_item")),t.hasTag("only_level_mining")&&t.hasTag("tuto_openSystemLevel")&&!t.hasTag("active_do_tuto22")&&!t.hasTag("used")&&(t.addTag("active_do_tuto22"),system.runTimeout(()=>{t.addTag("do_tuto22")},5)),!t.hasTag("active_do_tuto21")||t.hasTag("active_do_tuto21_2")||t.hasTag("level_ups")||t.hasTag("used")||(t.addTag("do_tuto21"),t.addTag("active_do_tuto21_2")),t.hasTag("goat_horns")&&t.hasTag("active_tuto27")&&!t.hasTag("active_do_tuto27")&&(t.addTag("active_do_tuto27"),system.runTimeout(()=>{t.addTag("do_tuto29")},5))}}if((t.hasTag("active_do_tuto19")||t.hasTag("active_tuto22"))&&(t.hasTag("active_do_tuto19")&&!t.isSneaking&&t.level>=6&&t.hasTag("active_do_tuto19")&&(t.addTag("active_do_tuto20"),t.removeTag("active_do_tuto19"),t.addTag("do_tuto20")),t.hasTag("active_tuto19")&&!t.isSneaking&&t.level<6&&t.addTag("black_room_func")),t.hasTag("active_tuto13")){const e=t.dimension.getBlock(t.location);if("minecraft:water"===e.typeId||"minecraft:flowing_water"===e.typeId){const e=world.scoreboard.getObjective("thermometer").getScore(t)??0;e<=6e3?(t.addTag("do_tuto14"),t.runCommandAsync("title @s subtitle thermometer_normal;")):(world.scoreboard.getObjective("thermometer").addScore(t,-1e3),system.runTimeout(()=>{t.onScreenDisplay.setTitle("ice_arrow")},5),t.onScreenDisplay.setTitle("tempnormal_sphere;"),e>6e3&&e<8e3&&t.runCommandAsync("title @s subtitle thermometer_normal;"),e>8e3&&e<1e4&&t.runCommandAsync("title @s subtitle thermometer_hot;"))}else setScore(t,"thermometer",12e3),setScore(t,"temperature",4),t.onScreenDisplay.setTitle("veryhot_sphere;"),t.runCommandAsync("title @s subtitle thermometer_veryhot;"),t.triggerEvent("hfrlc:sphere_veryhot"),t.applyDamage(1,{cause:"fire"})}if(t.hasTag("active_tuto14")){if(findFirstBlockOfType("minecraft:campfire",t.dimension,t.location,2)){const e=world.scoreboard.getObjective("thermometer").getScore(t)??0;e>=6e3?t.hasTag("do_tuto26_pre")||(t.sendMessage({translate:"tutorial.dialogue.subtitles23"}),t.runCommandAsync("title @s subtitle thermometer_normal;"),t.runCommandAsync("stopsound @s tutorial.dialogue.22"),t.playSound("tutorial.dialogue.23",{volume:9}),t.addTag("do_tuto26_pre"),system.runTimeout(()=>{t.addTag("do_tuto26_2"),t.triggerEvent("hfrlc:black_room")},160)):(world.scoreboard.getObjective("thermometer").addScore(t,1e3),system.runTimeout(()=>{t.onScreenDisplay.setTitle("fire_arrow")},5),t.onScreenDisplay.setTitle("tempnormal_sphere;"),e>4e3&&e<7e3&&t.runCommandAsync("title @s subtitle thermometer_normal;"),e>2e3&&e<5e3&&t.runCommandAsync("title @s subtitle thermometer_cold;"))}else world.scoreboard.getObjective("thermometer").setScore(t,1),world.scoreboard.getObjective("temperature").setScore(t,5),t.onScreenDisplay.setTitle("tempverycold_sphere;"),t.runCommandAsync("title @s subtitle thermometer_verycold;"),t.triggerEvent("hfrlc:sphere_verycold"),t.applyDamage(1,{cause:"freezing"})}if(t.hasTag("active_tuto9")){const e=i(t),a=["minecraft:oak_log","hfrlc:flint_axe","hfrlc:flint_dagger","hfrlc:flint_shard","minecraft:stick","hfrlc:water_flasks"];e.forEach(e=>{a.includes(e.typeId)||t.runCommandAsync(`clear @s ${e.typeId} 0 ${e.count}`)})}if(t.hasTag("active_tuto10")||t.hasTag("active_tuto16")){const e=i(t),a=["minecraft:oak_log","minecraft:oak_planks","hfrlc:flint_axe","hfrlc:flint_dagger","hfrlc:flint_shard","minecraft:stick","hfrlc:plant_fibers_rope","minecraft:wooden_pickaxe","hfrlc:water_flasks"];if(e.forEach(e=>{a.includes(e.typeId)||t.runCommandAsync(`clear @s ${e.typeId} 0 ${e.count}`)}),t.hasTag("active_tuto10")){const e=itemCount(t,"minecraft:oak_planks"),a=itemCount(t,"minecraft:oak_log"),o=itemCount(t,"minecraft:stick");if(e>12){const a=e-12;t.runCommandAsync(`clear @s minecraft:oak_planks 0 ${a}`)}if(a>3){const e=a-3;t.runCommandAsync(`clear @s minecraft:oak_log 0 ${e}`)}if(o>24){const e=o-24;t.runCommandAsync(`clear @s minecraft:stick 0 ${e}`)}}}if(t.hasTag("do_tuto0")&&(t.onScreenDisplay.setActionBar({translate:"translate.tutorial.crouch_to_skip"}),t.isSneaking&&!t.hasTag("used"))){const e=[0,2,3,4,5,6,7,8,9,10,16,19,20,22,23,24,25,11,12,13,14,"26_2",27,29,31],a=new Set([7,8,9,10,11,17,19,20,21,22,23,26,27]),o=t.getTags(),n=t=>e.indexOf(t),s=t=>"26_2"===t?"26_2":parseInt(t,10);o.forEach(o=>{if(!o.startsWith("active_tuto"))return;const r=s(o.slice(11)),i=n(r);if(i<0||i>=e.length-1)return;const c=e[i+1],d=`do_tuto${c}`;t.addTag(d),a.has("26_2"===c?26:c)&&t.addTag(`active_do_tuto${c}`),"26_2"===c&&t.triggerEvent("hfrlc:black_room")})}}export function doTutoItemCompleteUse(t,e){if(t.hasTag("start_game"))return;t.hasTag("active_tuto29")&&["hfrlc:water_flasks","minecraft:apple","minecraft:potion"].includes(e.typeId)&&system.runTimeout(()=>t.addTag("do_tuto31")),t.hasTag("active_tuto25")&&["hfrlc:bandage","hfrlc:heal1","hfrlc:heal2","hfrlc:heal3"].includes(e.typeId)&&(system.runTimeout(()=>t.addTag("do_tuto11"),10),t.triggerEvent("hfrlc:bodyparts_reset"))}export function doTutoBreakBlock(t,e,a,o,n){const s=`${a[0]} ${a[1]} ${a[2]}`;if(t.hasTag("start_game")&&(isLeavesBlock(e)?t.runCommandAsync(`loot spawn ${s} loot "stick"`):o&&isDagger(o)&&isGrassBlock(e)&&t.runCommandAsync(`loot spawn ${s} loot "plant_fibers"`)),e&&!t.hasTag("start_game")){if(isGravelBlock(e)&&breakGravel(t,s),isLeavesBlock(e)&&t.hasTag("active_tuto5")&&breakLeaves(t,a),isGrassBlock(e)&&processGrassTutorial(t,e,o,a,n),isLogBlock(e)&&(t.hasTag("active_do_tuto9")||t.hasTag("active_do_tuto10"))&&breakLogForTuto(t,e,a,o,n),isStoneBlock(e)&&breakStone(t,e,a,o),isLogBlock(e)&&!o?.hasTag("minecraft:is_axe")&&"creative"!==n&&!t.hasTag("desactive_hitlog")&&(killNearbyItems(t,s,2),t.hasTag("doing_mining_wood"))){const[e]=t.dimension.getEntities({type:"hfrlc:guide_texts",location:t.location,closest:1,maxDistance:20});e&&system.run(()=>{e.nameTag="It's not easy, right?"}),system.run(()=>{t.triggerEvent("hfrlc:tuto_cooldown2"),t.removeTag("doing_mining_wood")})}t.hasTag("do_tuto0")&&system.run(()=>setToMaxDurability(t,o)),system.run(()=>{o?.hasTag("hfrlc:break_block")&&"creative"!==n&&!t.hasTag("do_tuto0")&&Durability(t,o)})}}const isLogBlock=t=>t.typeId.includes("log"),isGravelBlock=t=>t.typeId.includes("gravel"),isLeavesBlock=t=>t.typeId.includes("leaves"),isGrassBlock=t=>t.typeId.includes("_grass")||"minecraft:fern"===t.typeId||"minecraft:large_fern"===t.typeId,isStoneBlock=t=>t.typeId.includes("stone"),isDagger=t=>t?.typeId.includes("dagger"),isAxe=t=>t?.typeId.includes("_axe"),killNearbyItems=(t,e,a=3)=>t.runCommandAsync(`execute as @s positioned ${e} run kill @e[type=item,r=${a}]`);function breakGravel(t,e){killNearbyItems(t,e),t.runCommandAsync("give @s flint 1"),system.runTimeout(()=>{t.addTag("do_tuto4")},20)}function breakLeaves(t,e){const a=`${e[0]} ${e[1]} ${e[2]}`;killNearbyItems(t,a),t.runCommandAsync("scoreboard players add @s leaves_tuto 1"),t.runCommandAsync("give @s stick 1"),system.run(()=>{getScore(t,"leaves_tuto")<2?system.runTimeout(()=>{t.runCommandAsync(`setblock ${a} leaves`)},4):(system.runTimeout(()=>{t.addTag("do_tuto6")},20),setScore(t,"leaves_tuto",0),t.runCommandAsync(`setblock ${e[0]} ${e[1]-2} ${e[2]} air`))})}function processGrassTutorial(t,e,a,o,n){const s=`${o[0]} ${o[1]} ${o[2]}`;"creative"!==n&&(isDagger(a)?(killNearbyItems(t,s),t.runCommandAsync("scoreboard players add @s plant_fibers 1"),t.runCommandAsync("give @s hfrlc:plant_fibers 1"),system.runTimeout(()=>{t.runCommandAsync(`execute as @s[scores={plant_fibers=..2}] run setblock ${s} short_grass`),system.run(()=>{getScore(t,"plant_fibers")>=3&&(setScore(t,"plant_fibers",0),t.runCommandAsync(`setblock ${o[0]} ${o[1]-2} ${o[2]} air`))})},4)):system.runTimeout(()=>{t.runCommandAsync(`setblock ${s} short_grass`),t.onScreenDisplay.setActionBar({translate:"translate.tutorial.break_grass_with_knife"})},4))}function breakLogForTuto(t,e,a,o,n){const s=`${a[0]} ${a[1]} ${a[2]}`;isAxe(o)?(killNearbyItems(t,s),t.runCommandAsync("scoreboard players add @s[tag=!active_do_tuto10] log_test 1"),t.runCommandAsync("give @s oak_log 1"),t.runCommandAsync(`execute as @s[tag=active_do_tuto10] run setblock ${s} oak_log`),system.run(()=>{getScore(t,"log_test")>=3&&system.runTimeout(()=>{t.addTag("do_tuto10"),t.runCommandAsync("clear @s hfrlc:flint_shard"),t.runCommandAsync("clear @s hfrlc:plant_fibers"),t.runCommandAsync("clear @s stick"),t.runCommandAsync("clear @s flint"),t.addTag("active_do_tuto10"),setScore(t,"log_test",0)},20)})):system.runTimeout(()=>{t.runCommandAsync(`setblock ${s} oak_log`),t.onScreenDisplay.setActionBar({translate:"translate.tutorial.break_log_with_axe"})},4)}function breakStone(t,e,a,o){const n=`${a[0]} ${a[1]} ${a[2]}`;o?.typeId.includes("pickaxe")?t.hasTag("active_do_tuto22")&&!t.hasTag("active_do_tuto23")&&(system.run(()=>{t.addTag("active_do_tuto23")}),system.runTimeout(()=>{t.addTag("do_tuto23")},5)):system.runTimeout(()=>{t.runCommandAsync(`setblock ${n} stone`),t.onScreenDisplay.setActionBar({translate:"translate.tutorial.break_stone_with_pickaxe"}),killNearbyItems(t,n)},4)}export function doTutoHitBlock(t,e){if(t.hasTag("do_tuto0")&&t.hasTag("active_tuto16")&&!t.hasTag("active_do_tuto19")){const e=t.getComponent(EntityEquippableComponent.componentId).getEquipment(EquipmentSlot.Mainhand);e?.typeId.includes("pickaxe")&&(t.addTag("active_do_tuto19"),system.runTimeout(()=>{t.addTag("do_tuto19")},5))}}export function doTutoHitEntity(t,e){t.hasTag("do_tuto0")&&e&&"minecraft:air"!==e.typeId&&setToMaxDurability(t,e)}export function doTutoItemUse(t,e){"hfrlc:trinket_menu"===e.typeId&&t.hasTag("do_tuto0")&&!t.hasTag("active_tuto27")&&(t.sendMessage({translate:"action.item_block"}),t.dimension.playSound("note.banjo",t.location,{pitch:.5}))}function findFirstBlockOfType(t,e,a,o){const n={x:a.x-o,y:e.heightRange.min,z:a.z-o},s={x:a.x+o,y:e.heightRange.max,z:a.z+o},r=new BlockVolume(n,s),i=e.getBlocks(r,{includeTypes:[t]});for(const t of i.getBlockLocationIterator())return e.getBlock(t);return null}export function handleLevelTuto(t){const e=t.level;e<6&&t.addLevels(6-e)}export function handleStartTutorial(t){const{dimension:e,location:a}=t,o=e.getTopmostBlock(a,e.heightRange.max);system.runTimeout(()=>{t.playSound("tutorial.dialogue.intro"),t.onScreenDisplay.setTitle("boss"),t.addTag("boss_title_tp");let e=0,n=a.z;const s=system.runInterval(()=>{t.hasTag("boss_title_tp")?(e+=.1,n+=.1,t.camera.setCamera("minecraft:free",{location:{x:a.x,y:o.location.y+2+e,z:n}})):system.clearRun(s)});system.runTimeout(()=>{t.onScreenDisplay.setTitle("honey"),system.runTimeout(()=>{t.camera.fade({fadeTime:{fadeInTime:1,holdTime:2,fadeOutTime:2}}),system.runTimeout(()=>{exitStartTutorial(t),system.runTimeout(()=>{t.camera.clear(),t.runCommandAsync("execute as @e[type=hfrlc:play_the_tutorial,r=20,c=1] run event entity @s hfrlc:choose_difficulty")},40)},20)},110)},110)},10)}export function exitStartTutorial(t){t.runCommandAsync("stopsound @s tutorial.dialogue.intro"),t.inputPermissions.cameraEnabled=!0,t.removeTag("boss_title_tp"),t.camera.clear(),t.runCommandAsync("execute as @e[type=hfrlc:play_the_tutorial,r=20,c=1] at @s run fill ~-2~1~ ~2~3~5 light_block_15"),t.runCommandAsync(`execute as @e[type=hfrlc:play_the_tutorial,r=20,c=1] at @s run tp "${t.name}" ~~1~5 180 -7.5`),t.runCommandAsync("fog @s push hfrlc:custom_fog_dragon custom_fog_dragon")}