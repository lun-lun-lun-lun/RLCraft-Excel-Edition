import{WeatherType as a,world as b,system as c}from"@minecraft/server";import{Vector as d}from"./vector.js";import{w as e}from"./functions.js";let f=a.Clear;function g([t,e],s){return t+(e-t)*s}function v(t){const e=Math.abs(((t+6e3)%24e3-12e3)/1e3);return 100*(-.02225388*Math.pow(e,3)+.48160593*Math.pow(e,2)+6.44275107*e+.08979647)*Math.sign((t+Math.sqrt(36e6))%24e3-12e3)/12e3*Math.PI}function z(t){const e=t%24e3;if(e>=23216||e<100){const t=e>=23216?(e-23216)/100:(e+784)/100;return Math.min(.5,.5*t)}if(e<6e3){return.5+.5*(e/6e3)}if(e<12686){return 1-.5*((e-6e3)/6686)}if(e<12786){const t=(e-12686)/100;return Math.max(0,.5-.5*t)}return 0}class SolarLensController{constructor(){this.a=b,this.b=e,this.c=new Map,this.d=new Map}run(){const t=this.a.getTimeOfDay(),e=t<12786||t>23216;if(f!==a.Clear||!e)return void this.h();const s=v(t),n={x:53*Math.sin(s+Math.PI),y:53*Math.cos(s),z:0};for(const e of this.b.getPlayers())e.hasTag("desactive_lens")?this.g(e):this.f(e,n,t)}f(t,e,s){const n={x:t.location.x,y:t.location.y+1.6,z:t.location.z},i=g([n.y,n.y],.2);this.c.set(t.id,i);const o=this.b.getBlockFromRay({x:n.x,y:i,z:n.z},e,{includeLiquidBlocks:!0,includePassableBlocks:!1,maxDistance:128}),a=!(!o?.block?.isValid()||o.block.isAir);if(a)return void this.g(t);const r=a?0:z(s);let c=g([this.d.get(t.id)??0,r],.2);if(c=Math.round(100*c)/100,this.d.set(t.id,c),c<.03)return;const l=`${t.name}`;let h=0;if(!t.hasTag("lens_active")){const s=t.dimension.spawnEntity("hfrlc:lens_sun",t.location);s.setProperty("hfrlc:brightness",c),s.teleport({x:n.x+e.x,y:i+e.y,z:n.z+e.z}),s.addTag(l),l.length>0&&s.playAnimation("animation.l_sun.position",{players:[l]}),t.addTag("lens_active")}for(const s of this.b.getEntities({type:"hfrlc:lens_sun"})){s.setProperty("hfrlc:brightness",c);for(const o of s.getTags())if(o.includes(l)){if(h++,h>1){s.remove();continue}const o=t.getVelocity();s.applyImpulse(o),s.teleport({x:n.x+e.x,y:i+e.y,z:n.z+e.z})}else s.playAnimation("animation.l_sun.position",{players:[l]})}}g(t){const e=`${t.name}`,s=this.b.getEntities({type:"hfrlc:lens_sun"});for(const n of s)for(const s of n.getTags())s.includes(e)?n.isValid()&&(n.remove(),t.removeTag("lens_active")):n.playAnimation("animation.l_sun.position",{players:[e]})}h(){const t=this.b.getEntities({type:"hfrlc:lens_sun"});for(const e of this.a.getPlayers()){if(e.hasTag("desactive_lens"))continue;const s=`${e.name}`;for(const n of t)for(const t of n.getTags())t.includes(s)&&n.isValid()&&(e.removeTag("lens_active"),n.remove())}}}b.afterEvents.weatherChange.subscribe(t=>{f=t.newWeather});export function lensFlareSpawn(t){t.hasTag("desactive_lens")||(e.getEntities({type:"hfrlc:lens_sun",tags:[`${t.name}`]}).forEach(t=>{t.remove()}),t.hasTag("its_raining")||t.removeTag("lens_active"))}const P1=new SolarLensController;export function lensSun_events(t,e){"hfrlc:lens_sun"==e&&t.hasTag("start_game")&&P1.run()}