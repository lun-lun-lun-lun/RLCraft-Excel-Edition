import{system,EntityDamageCause,GameMode}from"@minecraft/server";import{secondsToTicks,random}from"./libs/utils";import{bVector3}from"./libs/better_vectors";import{KNOCKBACK_EXCLUDED_ENTITIES}from"./tree_spirit";export const DATA={id:"hfrlc:cyclop",killed_check_delay:secondsToTicks(2),dancing:{min_time:8,max_time:16},states:{none:"none",attacking:"attacking",dancing:"dancing",grabbing:"grabbing",throwing:"throwing"},attack_types:{none:"none",attack_1:"attack_1",attack_2:"attack_2",attack_full:"attack_full"},attack_data:{attack_1:{duration:secondsToTicks(2.04),cooldown:secondsToTicks(1),hits:[{delay:secondsToTicks(.75),damage:10,knockback:1,radius:5,angle:35,special_effects:[]}]},attack_2:{duration:secondsToTicks(3.5),cooldown:secondsToTicks(1),hits:[{delay:secondsToTicks(.75),damage:10,knockback:1,radius:5,angle:35,special_effects:[]},{delay:secondsToTicks(2.05),damage:15,knockback:1,radius:7,angle:45,special_effects:[]}]},attack_full:{duration:secondsToTicks(5.33),cooldown:secondsToTicks(2),hits:[{delay:secondsToTicks(.75),damage:10,knockback:1,radius:5,angle:35,special_effects:[]},{delay:secondsToTicks(2.05),damage:15,knockback:1,radius:7,angle:45,special_effects:[]},{delay:secondsToTicks(3.6),damage:20,knockback:2,radius:9,angle:60,special_effects:["/camerashake add @a[r=16] 1.0 0.5 positional"]}]}}};export async function tick(t){if(t&&t.isValid()&&!t?.getProperty("hfrlc:dead")&&t?.getProperty("hfrlc:state")===DATA.states.attacking){let e=t?.getProperty("hfrlc:attack_type");if(e===DATA.attack_types.none)return;if(!t?.getDynamicProperty("hfrlc:attack_queued")){t?.setDynamicProperty("hfrlc:attack_queued",!0),t?.setDynamicProperty("hfrlc:target_dead",!1),t?.triggerEvent("hfrlc:end_idle"),t?.triggerEvent("hfrlc:movement_off");let a=DATA.attack_data[e];system.runTimeout(()=>{t&&t?.isValid()&&(t?.getDynamicProperty("hfrlc:target_dead")||t?.triggerEvent("hfrlc:end_attack"),system.runTimeout(()=>{t&&t?.isValid()&&(t?.triggerEvent("hfrlc:pick_attack"),t?.setDynamicProperty("hfrlc:attack_queued",!1))},a.cooldown))},a.duration);for(let e of a.hits)system.runTimeout(()=>{if(!t||!t?.isValid())return;if(t?.getDynamicProperty("hfrlc:target_dead"))return;for(let a of e.special_effects)t?.runCommand(a);let a=getTargets(t,e.radius,e.angle);for(let c of a){let a=bVector3.fromVector3(t.location),o=bVector3.fromVector3(c.location),r=bVector3.subtract(o,a);c.applyDamage(e.damage,{cause:EntityDamageCause.entityAttack,damagingEntity:t}),c.applyKnockback(r.x,r.z,e.knockback,.1);const i=c?.getComponent("minecraft:health");i?.currentValue<=0&&system.runTimeout(()=>{if(!t.getProperty("hfrlc:has_target")){t&&t?.isValid()&&t?.setDynamicProperty("hfrlc:target_dead",!0);const e=random(DATA.dancing.min_time,DATA.dancing.max_time);t&&t?.isValid()&&t?.triggerEvent("hfrlc:start_dancing"),system.runTimeout(()=>{t&&t?.isValid()&&t?.triggerEvent("hfrlc:pick_idle")},secondsToTicks(e))}},DATA.killed_check_delay)}},e.delay)}}}export function onEvent(t){t.entity.typeId===DATA.id&&("hfrlc:no_target"===t.eventId&&t.entity&&t.entity?.isValid()&&t.entity?.setDynamicProperty("hfrlc:target",void 0),"hfrlc:death"===t.eventId&&t.entity&&t.entity?.isValid()&&!t.entity.getProperty("hfrlc:rotation_locked")&&(t.entity.setProperty("hfrlc:rotation",t.entity.getRotation().y),t.entity.setProperty("hfrlc:rotation_locked",!0)))}function getDirection(t,e){let a=bVector3.fromVector3(t.location),c=bVector3.fromVector3(e.location);return bVector3.subtract(a,c)}function distanceToTarget(t,e){let a=bVector3.fromVector3(t?.location),c=bVector3.fromVector3(e.location);return bVector3.distance(a,c)}function getTargets(t,e,a){const c=t?.dimension.getEntities({location:t?.location,maxDistance:e,excludeFamilies:["inanimate"],excludeGameModes:[GameMode.creative,GameMode.spectator],excludeTypes:[DATA.id,...KNOCKBACK_EXCLUDED_ENTITIES]});let o=[];for(let e of c)targetIsInFront(t,e,a)&&o.push(e);return o}function targetIsInFront(t,e,a){const c=new bVector3(-Math.sin(t.getRotation().y*Math.PI/180),0,Math.cos(t.getRotation().y*Math.PI/180)),o=bVector3.subtract(bVector3.fromVector3(e.location),bVector3.fromVector3(t.location));c.normalize(),o.normalize();return bVector3.dotProduct(c,o)>Math.cos(a*Math.PI/180)}function getTarget(t){let e=!1;if(void 0!==t&&t?.isValid())return new Promise(a=>{t.triggerEvent("hf:get_target");const c=system.afterEvents.scriptEventReceive.subscribe(t=>{if("hf:get_target"===t.id)return e=!0,system.afterEvents.scriptEventReceive.unsubscribe(c),void a(t.sourceEntity)});system.runTimeout(()=>{system.afterEvents.scriptEventReceive.unsubscribe(c),e||a(null)},20)})}