import{world,system,EntityEquippableComponent,EquipmentSlot,EnchantmentType,ItemStack}from"@minecraft/server";import{addEffect,addDamage}from"./functions.js";import{despawn_and_save_items,restoreTrinketItems}from"./trinket.js";import{systemLevelReset}from"./system_level.js";export function itemsDamage(e,t,n,o,r){if(t&&"minecraft:player"==t.typeId&&e){const n=t.getComponent(EntityEquippableComponent.componentId),o=n?.getEquipment(EquipmentSlot.Head),r=n?.getEquipment(EquipmentSlot.Chest),a=n?.getEquipment(EquipmentSlot.Legs),i=n?.getEquipment(EquipmentSlot.Feet);o&&r&&a&&i&&(o.typeId.includes("_dragon_helmet")||r.typeId.includes("_dragon_chestplate")||a.typeId.includes("_dragon_leggings")||i.typeId.includes("_dragon_boots"))&&(t.hasTag("level_armor10")||e.applyDamage(2),t.addTag("dragon_armor_equip")),o||r||a||i||t.removeTag("dragon_armor_equip")}if(e&&"minecraft:player"==e.typeId){"entityAttack"==o&&e.hasTag("withering_necklace")&&addEffect(t,"wither",30,3,!0);const n=e.getComponent(EntityEquippableComponent.componentId),a=n?.getEquipment(EquipmentSlot.Mainhand);a&&("hfrlc:dragon_bone_dagger"==a.typeId&&Math.floor(100*Math.random())+1>50&&addDamage(t,Math.round(r),e),a.typeId.includes("ice_dragon_bone_")&&(addEffect(t,"wither",30,3,!0),"hfrlc:wyvern_fire"!=t.typeId&&"hfrlc:dragon_fire"!=t.typeId||addDamage(t,Math.round(r/2),e)),a.typeId.includes("fire_dragon_bone_")&&(t.setOnFire(5,!0),"hfrlc:wyvern_ice"!=t.typeId&&"hfrlc:dragon_ice"!=t.typeId||addDamage(t,Math.round(r/2),e)),"hfrlc:fire_sword"==a.typeId&&t.setOnFire(5,!0))}}export function Durability(e,t){system.run(()=>{const n=t.getComponent(EntityEquippableComponent.componentId),o=e.getComponent("durability");if(e&&void 0!==o)if(o.damage+4<o.maxDurability)o.damage=o.damage+4,n.setEquipment(EquipmentSlot.Mainhand,e);else if(o.damage+4>=o.maxDurability){const e=new ItemStack("minecraft:air");n.setEquipment(EquipmentSlot.Mainhand,e),t.playSound("random.break")}})}export function BreakBlock(e,t){system.run(()=>{const n=t.getComponent(EntityEquippableComponent.componentId),o=e.getComponent("durability");if(e&&void 0!==o)if(o.damage+2<o.maxDurability)o.damage=o.damage+2,n.setEquipment(EquipmentSlot.Mainhand,e);else if(o.damage+2>=o.maxDurability){const e=new ItemStack("minecraft:air");n.setEquipment(EquipmentSlot.Mainhand,e),t.playSound("random.break")}})}export function setToMaxDurability(e,t){const n=t?.getComponent("durability"),o=e.getComponent("equippable");if(n){const e=n.maxDurability,r=n.damage;n.damage=Math.max(0,r-(e-r)),o.setEquipment(EquipmentSlot.Mainhand,t)}}export function saveInventory(e){let t={};const n=e.getComponent("inventory").container,o=n.size;for(let e=0;e<o;e++){const o=n.getItem(e);if(!o)continue;let r={typeId:o.typeId,count:o.amount,lore:[],enchantments:[],keepOnDeath:!1,lockInInventory:"none"};const a=o.getLore();a.length>0&&(r.lore=a),1==o.keepOnDeath&&(r.keepOnDeath=!0),"inventory"==o.lockMode&&(r.lockInInventory="inventory");const i=o.getComponent("enchantable");if(i){const e=i.getEnchantments();e.length>0&&(r.enchantments=e.map(e=>({id:e.type.id,level:e.level})))}const m=o.nameTag;m&&(r.customName=m),t[`item_${e}`]=r}const r=["Head","Chest","Legs","Feet"],a=e.getComponent("equippable");for(const e of r){const n=a.getEquipmentSlot(e)?.getItem();if(!n)continue;let o={typeId:n.typeId,count:n.amount,lore:[],enchantments:[]};const r=n.getLore();r.length>0&&(o.lore=r);const i=n.getComponent("enchantable");if(i){const e=i.getEnchantments();e.length>0&&(o.enchantments=e.map(e=>({id:e.type.id,level:e.level})))}const m=n.nameTag;m&&(o.customName=m),t[`equipment_${e}`]=o,a.setEquipment(e,void 0)}const i=e.getTotalXp(),m=world.scoreboard.getObjective("thirst").getScore(e)??0,c=world.scoreboard.getObjective("thermometer").getScore(e)??0,l=world.scoreboard.getObjective("melee").getScore(e)??0,s=world.scoreboard.getObjective("mining").getScore(e)??0,d=world.scoreboard.getObjective("armor").getScore(e)??0,p=world.scoreboard.getObjective("agility").getScore(e)??0;t.XPL=i,t.thirstbar=m,t.thermometer=c,t.meleeLevel=l,t.miningLevel=s,t.armorLevel=d,t.agilityLevel=p;const g=despawn_and_save_items(e);t.trinkets=g;let y=JSON.stringify(t);world.setDynamicProperty(`hfrlc:savedInventory_${e.id}`,y),n.clearAll(),e.resetLevel(),systemLevelReset(e)}export function giveSavedInventory(e){const t=e.getComponent("inventory").container;t.clearAll();const n=world.getDynamicProperty(`hfrlc:savedInventory_${e.id}`);if(!n)return;const o=JSON.parse(n);for(const e in o)if(e.startsWith("item_")){const n=o[e],r=new ItemStack(n.typeId,n.count);if(n.lore&&n.lore.length>0&&r.setLore(n.lore),n.enchantments&&n.enchantments.length>0){const e=r.getComponent("enchantable");for(const t of n.enchantments)e.addEnchantment({type:new EnchantmentType(t.id),level:t.level})}n.customName&&(r.nameTag=n.customName),1==n.keepOnDeath&&(r.keepOnDeath=!0),"inventory"==n.lockInInventory&&(r.lockMode="inventory"),t.addItem(r)}const r=["Head","Chest","Legs","Feet"],a=e.getComponent("equippable");for(const e of r){const t=o[`equipment_${e}`];if(!t)continue;const n=new ItemStack(t.typeId,t.count);if(t.lore&&t.lore.length>0&&n.setLore(t.lore),t.enchantments&&t.enchantments.length>0){const e=n.getComponent("enchantable");for(const n of t.enchantments)e.addEnchantment({type:new EnchantmentType(n.id),level:n.level})}t.customName&&(n.nameTag=t.customName),a.setEquipment(e,n)}e.addExperience(o.XPL),world.scoreboard.getObjective("thirst").setScore(e,o.thirstbar),world.scoreboard.getObjective("thermometer").setScore(e,o.thermometer),world.scoreboard.getObjective("melee").setScore(e,o.meleeLevel),world.scoreboard.getObjective("mining").setScore(e,o.miningLevel),world.scoreboard.getObjective("armor").setScore(e,o.armorLevel),world.scoreboard.getObjective("agility").setScore(e,o.agilityLevel),e.setProperty("hfrlc:melee_unlock",o.meleeLevel),e.setProperty("hfrlc:mining_unlock",o.miningLevel),e.setProperty("hfrlc:armor_unlock",o.armorLevel),e.setProperty("hfrlc:agility_unlock",o.agilityLevel);const i=o.trinkets??[];restoreTrinketItems(e,JSON.stringify({trinkets:i})),world.setDynamicProperty(`hfrlc:savedInventory_${e.id}`,void 0),e.dimension.playSound("armor.equip_generic",e.location)}